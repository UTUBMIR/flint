"use strict";(()=>{var me=Object.create;var Z=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var fe=Object.getPrototypeOf,ye=Object.prototype.hasOwnProperty;var c=(r,e)=>Z(r,"name",{value:e,configurable:!0}),ge=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var be=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of he(e))!ye.call(r,i)&&i!==t&&Z(r,i,{get:()=>e[i],enumerable:!(n=de(e,i))||n.enumerable});return r};var ve=(r,e,t)=>(t=r!=null?me(fe(r)):{},be(e||!r||!r.__esModule?Z(t,"default",{value:r,enumerable:!0}):t,r));var M=(r,e,t,n)=>{for(var i=n>1?void 0:n?de(e,t):e,s=r.length-1,o;s>=0;s--)(o=r[s])&&(i=(n?o(e,t,i):o(i))||i);return n&&i&&Z(e,t,i),i};var Q=class{static{c(this,"Renderer2D")}canvas;ctx;_fontSize=18;_fontStyle="Arial";setCanvas(e,t){this.canvas=e,this.ctx=t,this.updateFont()}set fillColor(e){this.ctx.fillStyle=e}set lineColor(e){this.ctx.strokeStyle=e}set lineWidth(e){this.ctx.lineWidth=e}set lineJoin(e){this.ctx.lineJoin=e}set shadowColor(e){this.ctx.shadowColor=e}set shadowBlur(e){this.ctx.shadowBlur=e}set textBaseLine(e){this.ctx.textBaseline=e}set textAlign(e){this.ctx.textAlign=e}set fontSize(e){this._fontSize=e,this.updateFont()}set fontStyle(e){this._fontStyle=e,this.updateFont()}resetTransform(){this.ctx.resetTransform()}translate(e){this.ctx.translate(e.x,e.y)}rotate(e){this.ctx.rotate(e)}updateFont(){this.ctx.font=this._fontSize.toString()+"px "+this._fontStyle}clearCanvas(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}fillCanvas(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}fillRect(e,t){this.ctx.fillRect(e.x,e.y,t.x,t.y)}strokeRect(e,t){this.ctx.strokeRect(e.x-this.ctx.lineWidth/2,e.y-this.ctx.lineWidth/2,t.x+this.ctx.lineWidth,t.y+this.ctx.lineWidth)}fillText(e,t){this.ctx.fillText(t,e.x,e.y)}strokeText(e,t){this.ctx.strokeText(t,e.x,e.y)}makePath(e){this.ctx.beginPath();let t=e[0];t&&this.ctx.moveTo(t.x,t.y);for(let n=1;n<e.length;++n){let i=e[n];i&&this.ctx.lineTo(i.x,i.y)}this.ctx.closePath()}fillPolygon(e){this.makePath(e),this.ctx.fill()}strokePolygon(e){this.makePath(e),this.ctx.stroke()}};var b=class r{static{c(this,"Vector2D")}static zero=new r;x;y=0;constructor(e=0,t){this.x=e,t!==void 0?this.y=t:this.y=e}set(e,t){return this.x=e,this.y=t,this}copy(){return new r(this.x,this.y)}add(e){return new r(this.x+e.x,this.y+e.y)}subtract(e){return new r(this.x-e.x,this.y-e.y)}multiply(e){return e instanceof r?new r(this.x*e.x,this.y*e.y):new r(this.x*e,this.y*e)}divide(e){return e instanceof r?new r(this.x/e.x,this.y/e.y):new r(this.x/e,this.y/e)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(e=1){let t=this.magnitude();return t===0?new r(0,0):new r(this.x/t*e,this.y/t*e)}clamp(e,t){return new r(Math.max(e.x,Math.min(t.x,this.x)),Math.max(e.y,Math.min(t.y,this.y)))}};var E=class r{static{c(this,"Input")}static pressedKeys=new Set;static pressedMouseButtons=new Set;static inputAxes=[];static mousePosition=new b(window.innerWidth/2,window.innerHeight/2);constructor(){}static get pressedKeyCount(){return r.pressedKeys.size}static isKeyPressed(e){return this.pressedKeys.has(e)}static isMouseButtonPressed(e){return this.pressedMouseButtons.has(e)}static getAxis(e){let t=this.inputAxes.find(n=>n.name===e);if(!t)throw new Error(`InputAxis with name ${e} does not exist!`);return t.value}static init(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("touchstart",this.onMouseMove.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("touchmove",this.onMouseMove.bind(this))}static onKeyDown(e){this.pressedKeys.add(e.code),this.updateInputAxes()}static onKeyUp(e){this.pressedKeys.delete(e.code),this.updateInputAxes()}static onMouseDown(e){this.pressedMouseButtons.add(e.button),this.updateInputAxes()}static onMouseUp(e){this.pressedMouseButtons.delete(e.button),this.updateInputAxes()}static onMouseMove(e){e instanceof MouseEvent?this.mousePosition.set(e.pageX,e.pageY):e.touches[0]&&this.mousePosition.set(e.touches[0].pageX,e.touches[0].pageY)}static updateInputAxes(){for(let e of this.inputAxes)e.update()}};var W=class{static{c(this,"SystemEvent")}_type;stopNextLayer=!1;stopImmediate=!1;get type(){return this._type}constructor(e){this._type=e}stopPropagationToNextLayer(){this.stopNextLayer=!0}stopImmediatePropagation(){this.stopImmediate=!0}},U=class{static{c(this,"SystemEventEmitter")}listeners=[];reversed;stopImmediate;constructor(e=!1,t=!1){this.reversed=t,this.stopImmediate=e}addEventListener(e){this.reversed?this.listeners.unshift(e):this.listeners.push(e)}dispatchEvent(e){for(let t=0;t<this.listeners.length;++t){let n=this.listeners[t];if(!n)return!0;if(n(e),this.stopImmediate){if(e.stopImmediate)return e.stopPropagationToNextLayer(),!1;if(e.stopNextLayer)return!1}}return!0}removeEventListener(e){let t=this.listeners.indexOf(e);t!=-1&&this.listeners.splice(t,1)}};var pe={input:[{name:"horizontal",bindings:[{value:-1,keys:[{type:"keyboard",code:["KeyA","ArrowLeft"]}]},{value:1,keys:[{type:"keyboard",code:["KeyD","ArrowRight"]}]}]},{name:"vertical",bindings:[{value:-1,keys:[{type:"keyboard",code:["KeyW","ArrowUp"]}]},{value:1,keys:[{type:"keyboard",code:["KeyS","ArrowDown"]}]}]}]};var z=class{static{c(this,"InputAxis")}name;bindings;_value=0;get value(){return this._value}constructor(e,t){this.name=e,t?this.bindings=new Set(t):this.bindings=new Set}addBinding(e){this.bindings.add(e)}removeBinding(e){this.bindings.delete(e)}update(){this._value=0;for(let e of this.bindings)for(let t of e.keys)this.isKeyActive(t)&&(this._value+=e.value);this._value=Math.max(-1,Math.min(1,this._value))}isKeyActive(e){for(let t of e.code)switch(e.type){case"keyboard":if(E.isKeyPressed(t.toString()))return!0;break;case"mouse":if(E.isMouseButtonPressed(+t))return!0;break;case"gamepad":new Error('Input device "Gamepad" is not implemented.');break}}};var $=class{static{c(this,"NumberRenderer")}canRender(e){return e==="number"}render(e,t,n,i){this.update=()=>{let l=a(s.get(),6).toString();o.value!==l&&(o.value=l)};let s={get:c(()=>n(e,t),"get"),set:c(l=>i(e,t,l),"set"),update:this.update},o=document.createElement("sl-input");o.type="number",o.step=10,o.addEventListener("sl-input",l=>{let d=parseFloat(l.target.value);Number.isNaN(d)||s.set(d),l.target.value===""&&s.set(0)});function a(l,d){let m=Math.pow(10,d);return Math.round(l*m)/m}c(a,"roundUpTo");for(let l of C.getBehaviors("number"))l.attach(o,s);return s.update(),o}update(){}};var _=class{static{c(this,"WheelScrubBehavior")}speed=.5;shiftMult=8;ctrlMult=.1;attach(e,t){let n=c(i=>{if(document.activeElement!=e)return;i.preventDefault();let s=i.deltaY*-.1;s*=this.speed,i.shiftKey&&(s*=this.shiftMult),i.ctrlKey&&(s*=this.ctrlMult);let o=(parseFloat(e.value)||0)+s;t.set(o),t.update()},"handleWheel");e.addEventListener("wheel",n,{passive:!1})}};var ee=class{static{c(this,"DragScrubBehavior")}dragSpeed=.5;shiftMult=8;ctrlMult=.1;attach(e,t){let n=!1,i=0,s=!1,o=!1,a=4,l=3,d=0,m=!1,T=c(g=>g<=a||g>=window.innerWidth-a,"shouldLockPointer"),O=c(g=>{if(!n)return;if(!m){let oe=g.clientX-d;if(Math.abs(oe)<l)return;m=!0}if(!s&&T(g.clientX)){s=!0,o=!0,e.requestPointerLock();return}if(s&&o){o=!1;return}let N=g.movementX;N*=this.dragSpeed,g.shiftKey&&(N*=this.shiftMult),g.ctrlKey&&(N*=this.ctrlMult);let G=i+N;i=G,t.set(G),t.update()},"handleMouseMove"),R=c(()=>{n=!1,m=!1,s&&(s=!1,document.exitPointerLock()),window.removeEventListener("mousemove",O),window.removeEventListener("mouseup",R)},"stopDragging");e.addEventListener("mousedown",g=>{g.button===0&&(d=g.clientX,i=parseFloat(e.value)||0,m=!1,n=!0,s=!1,o=!1,window.addEventListener("mousemove",O),window.addEventListener("mouseup",R))})}};var te=class{static{c(this,"ColorRenderer")}canRender(e){return e==="color"}render(e,t,n,i){this.update=()=>{let a=s.get();o.value!==a&&(o.value=a)};let s={get:c(()=>n(e,t),"get"),set:c(a=>i(e,t,a),"set"),update:this.update},o=document.createElement("sl-color-picker");o.noFormatToggle=!0,o.hoist=!0,o.addEventListener("sl-input",a=>s.set(a.target.value));for(let a of C.getBehaviors("color"))a.attach(o,s);return s.update(),o}update(){}};var ne=class{static{c(this,"StringRenderer")}canRender(e){return e==="string"}render(e,t,n,i){this.update=()=>{let a=s.get();o.value!==a&&(o.value=a)};let s={get:c(()=>n(e,t),"get"),set:c(a=>i(e,t,a),"set"),update:this.update},o=document.createElement("sl-input");o.addEventListener("sl-input",a=>{s.set(a.target.value)});for(let a of C.getBehaviors("string"))a.attach(o,s);return s.update(),o}update(){}};var f=class r{static{c(this,"Metadata")}static classMeta=new Map;static fieldMeta=new Map;static enabled=!0;static folderHandle=void 0;static setClass(e,t,n){if(!r.enabled)throw new Error("Metadata is disabled");let i=this.classMeta.get(e);i||(i=new Map,this.classMeta.set(e,i)),i.set(t,n),this.changed()}static getClass(e,t){let n=e;for(;n;){let i=this.classMeta.get(n)?.get(t);if(i!==void 0)return i;n=Object.getPrototypeOf(n)}}static setField(e,t,n,i){if(!r.enabled)throw new Error("Metadata is disabled");let s=this.fieldMeta.get(e);s||(s=new Map,this.fieldMeta.set(e,s));let o=s.get(t);o||(o=new Map,s.set(t,o)),o.set(n,i),this.changed()}static getField(e,t,n){let i=e;for(;i;){let o=this.fieldMeta.get(i)?.get(t);if(o?.has(n))return o.get(n);i=Object.getPrototypeOf(i)}}static getFieldAll(e,t){let n=e;for(;n;){let s=this.fieldMeta.get(n)?.get(t);if(s)return s;n=Object.getPrototypeOf(n)}return null}static importFrom(e){for(let[t,n]of e.classMeta){let i=this.classMeta.get(t);i||(i=new Map,this.classMeta.set(t,i));for(let[s,o]of n)i.set(s,o)}for(let[t,n]of e.fieldMeta){let i=this.fieldMeta.get(t);i||(i=new Map,this.fieldMeta.set(t,i));for(let[s,o]of n){let a=i.get(s);a||(a=new Map,i.set(s,a));for(let[l,d]of o)a.set(l,d)}}this.changed()}static changed(){this.folderHandle&&this.saveToFile(this.folderHandle)}static async saveToFile(e){}static async loadFromFile(e){}};var ie=class extends ${static{c(this,"AngleRenderer")}constructor(){super(),this.canRender=e=>e==="angle"}render(e,t,n,i){let s=c((a,l)=>(360+n(a,l)*(180/Math.PI))%360,"newGet"),o=c((a,l,d)=>i(a,l,d%360*(Math.PI/180)),"newSet");return super.render(e,t,s,o)}};var re=class{static{c(this,"BooleanRenderer")}canRender(e){return e==="boolean"}render(e,t,n,i){this.update=()=>{let a=!!s.get();o.checked!==a&&(o.checked=a)};let s={get:c(()=>n(e,t),"get"),set:c(a=>i(e,t,a),"set"),update:this.update},o=document.createElement("sl-checkbox");o.addEventListener("sl-input",a=>{s.set(!!a.target.checked)});for(let a of C.getBehaviors("string"))a.attach(o,s);return s.update(),o}update(){}};function B(r){return(e,t)=>{f.setField(e,t,"field-renderer",r)}}c(B,"customRenderer");function ue(){return(r,e)=>{f.setField(r,e,"hide-in-inspector",!0)}}c(ue,"hideInInspector");var H=class{static{c(this,"RendererRegistry")}static renderers=[];static register(e){this.renderers.push(e)}static getRenderer(e){return this.renderers.find(t=>t.canRender(e))}},C=class{static{c(this,"BehaviorRegistry")}static map=new Map;static register(e,t){this.map.has(e)||this.map.set(e,[]),this.map.get(e).push(t)}static getBehaviors(e){return this.map.get(e)??[]}},j=class{static{c(this,"ComponentBuilder")}static fields=[];constructor(){}static get(e,t){let n=e;for(let i of t){if(n==null)return;n=n[i]}return n}static set(e,t,n){if(t.length===0)throw new Error("Path must have at least one element");let i=e;for(let o=0;o<t.length-1;o++){let a=t[o];if(!a)throw new Error("Failed to get key");i[a]==null&&(i[a]={}),i=i[a]}let s=t[t.length-1];if(!s)throw new Error("Path was not found");i[s]=n}static lastKey(e){return e.length>0?e[e.length-1]??"":""}static isPlainObject(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}static splitPascalCase(e,t=" "){let n=/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g,i=e.match(n);return i?i.join(t).toLowerCase():e}static joinToPascalCase(e){return e&&e.replace(/[-_]+/g," ").replace(/\s+/g," ").trim().split(" ").map(n=>n.length===0?n:n[0].toUpperCase()+n.slice(1).toLowerCase()).join("")}static wrapField(e,t){let n=document.createElement("div");n.classList.add("inspector-field");let i=document.createElement("label");return i.classList.add("inspector-label"),i.textContent=this.splitPascalCase(e),n.appendChild(i),n.appendChild(t),n}static label(e){return Object.assign(document.createElement("h4"),{textContent:e})}static field(e,t){let n=this.lastKey(t),i=this.get(e,t),s=typeof i,o=this.get(e,t.slice(0,t.length-1));o||(o=e);let a=f.getField(o,n,"field-renderer"),l=c(d=>{let m=this.wrapField(this.lastKey(t),d.render(e,t,this.get,this.set));return d.update&&this.fields.push({update:d.update}),m},"render");if(a){let d=H.getRenderer(a);if(d)return l(d);let m=document.createElement("span");return m.textContent=`[${a}]`,this.wrapField(n,m)}if(!this.isPlainObject(i)){let d=H.getRenderer(s);if(d)return l(d);let m=document.createElement("span");return m.textContent=`[${s}]`,this.wrapField(n,m)}return this.tree(e,t)}static tree(e,t){let n=this.get(e,t),i=document.createElement("sl-tree-item");i.expanded=!0,i.textContent=this.lastKey(t)||"root";for(let s of Object.keys(n)){if(f.getField(n,s,"hide-in-inspector"))continue;let o=[...t,s],a=this.field(e,o);if(document.createElement("div").appendChild(a),this.isPlainObject(n[s]))i.appendChild(a);else{let d=document.createElement("sl-tree-item");d.classList.add("no-caret"),d.appendChild(a),i.appendChild(d)}}return i}static build(e){let t=document.createElement("sl-tree");for(let n of Object.keys(e)){if(f.getField(e,n,"hide-in-inspector"))continue;let i=[n],s=this.field(e,i);if(s.tagName!=="SL-TREE-ITEM"){let o=document.createElement("sl-tree-item");o.classList.add("no-caret"),o.appendChild(s),t.appendChild(o)}else t.appendChild(s)}return t}static clearFields(){this.fields=[]}static updateFields(){for(let e of this.fields)e.update()}};H.register(new $);H.register(new te);H.register(new re);H.register(new ne);H.register(new ie);C.register("number",new _);C.register("number",new ee);var I=class{static{c(this,"Component")}gameObject;get transform(){return this.gameObject.transform}attach(){}start(){}update(){}detach(){}destroy(){this.gameObject=void 0}swapClass(e){let t=new e;for(let n of Object.keys(this))t[n]=this[n];return t}};M([ue()],I.prototype,"gameObject",2);var A=class extends I{static{c(this,"RendererComponent")}render(e){}};var P=class extends A{static{c(this,"Camera")}enabled=!0;backgroundColor="#222";get position(){return this.transform.position}get angle(){return this.transform.angle}attach(){this.gameObject.layer.cameras.push(this)}};M([B("color")],P.prototype,"backgroundColor",2);var S=class extends A{static{c(this,"Shape")}fillColor="#cfd2ee";lineColor="#2e69b6";shadowColor="#1c649b";attach(){this.gameObject.layer.renderSystem.register(this)}detach(){this.gameObject.layer.renderSystem.unregister(this)}render(e){e.fillColor=this.fillColor,e.lineColor=this.lineColor,e.lineWidth=5,e.lineJoin="bevel",e.translate(this.transform.position),e.rotate(this.transform.angle),e.translate(b.zero.subtract(this.transform.position)),e.shadowColor=this.shadowColor,e.shadowBlur=20,e.fillRect(this.transform.position.subtract(this.transform.size.divide(2)),this.transform.size),e.strokeRect(this.transform.position.subtract(this.transform.size.divide(2)),this.transform.size),e.translate(this.transform.position),e.rotate(-this.transform.angle),e.translate(b.zero.subtract(this.transform.position))}};M([B("color")],S.prototype,"fillColor",2),M([B("color")],S.prototype,"lineColor",2),M([B("color")],S.prototype,"shadowColor",2);var se=class{static{c(this,"RenderSystem")}components=[];register(e){this.components.push(e)}unregister(e){let t=this.components.indexOf(e);t!==-1&&this.components.splice(t,1)}render(e){for(let t of this.components)t.render(e)}},p=class r{static{c(this,"System")}static layers=[];static components=new Map;static showColliders=!1;static dpr=window.devicePixelRatio||1;static lastFrame;static _deltaTime;static rootDiv;static renderingContext=CanvasRenderingContext2D;static _renderer;static eventEmitter=new U(!1,!0);static _runningState=0;static get runningState(){return r._runningState}static get deltaTime(){return this._deltaTime}static get fps(){return 1/this._deltaTime}static get renderer(){return this._renderer}static setCursor(e){r.rootDiv.style.cursor=e}constructor(){}static getGameObjectById(e){for(let t of r.layers){let n=t.getObjects().find(i=>i.uuid===e);if(n)return n}}static addBasicComponents(){this.components.set("Camera",P),this.components.set("Shape",S)}static init(e){this.initRootDiv(),this._renderer=e,E.init(),this.loadPlayConfig(pe),this.addBasicComponents(),this.rootDiv.addEventListener("contextmenu",t=>t.preventDefault());for(let t of["mousedown","mouseup","mousemove","touchstart","touchmove","touchend"])document.addEventListener(t,this.sendEventToLayers.bind(this))}static pushLayer(e){e.canvas=this.createCanvas(),e.renderer=this._renderer,this.eventEmitter.addEventListener(e.onEvent.bind(e)),this.layers.push(e),e.attach(),r.runningState===1&&e.start()}static removeLayer(e){let t=r.layers.indexOf(e);t!==-1&&r.layers.splice(t,1)}static run(){requestAnimationFrame(r.mainTick.bind(r)),r.lastFrame=performance.now(),r._runningState=1}static runRenderingOnly(){requestAnimationFrame(r.renderOnlyTick.bind(r)),r.lastFrame=performance.now(),r._runningState=2}static stop(){r._runningState=0}static mainTick(e){this._deltaTime=(e-this.lastFrame)/1e3,this.lastFrame=e;for(let t of this.layers)t.update();for(let t of this.layers)t.render();r._runningState===1&&requestAnimationFrame(r.mainTick.bind(r))}static renderOnlyTick(e){this._deltaTime=(e-this.lastFrame)/1e3,this.lastFrame=e;for(let t of this.layers)t.render();r._runningState===2&&requestAnimationFrame(r.renderOnlyTick.bind(r))}static createCanvas(){let e=document.createElement("canvas"),t=this.getContextName(this.renderingContext.name),n=e.getContext(t);if(!n)throw new Error(`Rendering context ${t} was not found!`);return this.addResizing(e),n instanceof CanvasRenderingContext2D&&n.scale(r.dpr,r.dpr),this.rootDiv.appendChild(e),{element:e,ctx:n}}static getContextName(e){switch(e){case CanvasRenderingContext2D.name:return"2d";case WebGLRenderingContext.name:return"webgl";case WebGL2RenderingContext.name:return"webgl2";default:throw new Error(`Unsupported context type: "${e}"`)}}static addResizing(e){new ResizeObserver(()=>{setTimeout(()=>{e.width=+this.rootDiv.clientWidth,e.height=+this.rootDiv.clientHeight},0)}).observe(this.rootDiv)}static initRootDiv(e="root"){let t=document.getElementById(e);if(!t||!(t instanceof HTMLDivElement))throw new Error(`Html element with type "div" and id "${e}" was not found!`);this.rootDiv=t}static sendEventToLayers(e){this.eventEmitter.dispatchEvent(new W(e.type))}static loadPlayConfig(e){E.inputAxes=e.input.map(t=>new z(t.name,t.bindings))}};var D=class extends I{static{c(this,"Transform")}position;size;angle;constructor(e,t,n){super(),this.position=e??new b,this.size=t??new b(1,1),this.angle=n??0}};M([B("angle")],D.prototype,"angle",2);var w=class{static{c(this,"GameObject")}layer;components=[];transform;uuid;constructor(e,t,n){this.transform=t??new D,this.transform.gameObject=this,this.uuid=n??crypto.randomUUID(),e&&this.addComponents(e)}get isAttached(){return!!this.layer}getAllComponents(){return this.components}start(){for(let e of this.components)e.start()}attach(){for(let e of this.components)e.attach()}update(){this.updateComponents()}updateComponents(){for(let e of this.components)e.update(),e.gameObject=this}detach(){for(let e of this.components)e.detach()}destroy(){this.isAttached&&this.detach();for(let e of this.components)e.destroy();this.transform.detach(),this.transform.destroy(),this.components.length=0}addComponent(e){return e.gameObject=this,this.components.push(e),this.isAttached&&(e.attach(),p.runningState===1&&e.start()),e}addComponents(e){for(let t of e)t.gameObject=this,this.components.push(t);if(this.isAttached){for(let t of e)t.attach();if(p.runningState===1)for(let t of e)t.start()}return e}getComponent(e){return this.components.find(t=>t instanceof e)}getComponents(e){return this.components.filter(t=>t instanceof e)}hasComponent(e){return this.components.some(t=>t instanceof e)}removeComponent(e){let t=this.components.findIndex(n=>n instanceof e);return t===-1?!1:(this.isAttached&&this.components[t].detach(),this.components[t].destroy(),this.components=this.components.splice(t,1),!0)}requireComponent(e){let t=this.getComponent(e);if(!t)throw new Error(`Required component ${e.name??"Unknown"} was not found.`);return t}};var L=class{static{c(this,"Layer")}canvas;renderer;objects=[];eventEmitter=new U(!0,!0);cameras=[];renderSystem=new se;attach(){}start(){for(let e of this.objects)e.start()}update(){this.updateObjects()}render(){this.renderObjects()}detach(){}destroy(){for(let e of this.objects)e.destroy()}updateObjects(){for(let e of this.objects)e.update()}renderObjects(){if(this.cameras.length!==0){this.renderer.setCanvas(this.canvas.element,this.canvas.ctx),this.renderer.clearCanvas();for(let e of this.cameras)if(e.enabled){this.renderer.fillColor=e.backgroundColor,this.renderer.fillCanvas(),this.renderer.resetTransform();let t=new b(this.canvas.ctx.canvas.width,this.canvas.ctx.canvas.height).divide(2);this.renderer.translate(t),this.renderer.rotate(e.angle),this.renderer.translate(b.zero.subtract(e.position)),this.renderSystem.render(this.renderer)}}}addObject(e){return this.objects.push(e),e.layer=this,e.attach(),p.runningState===1&&e.start(),e}addObjects(e){for(let t of e)this.objects.push(t),t.layer=this;for(let t of e)t.attach();if(p.runningState===1)for(let t of e)t.start();return e}removeObject(e){let t=this.objects.indexOf(e);t!==-1&&(this.objects[t].destroy(),this.objects.splice(t,1))}getObjects(){return this.objects}onEvent(e){this.eventEmitter.dispatchEvent(new W(e.type))}};var K=class{static{c(this,"ModuleLoader")}constructor(){}static createTempURL(e,t="text/javascript"){let n=new Blob([e],{type:t});return URL.createObjectURL(n)}static deleteTempUrl(e){URL.revokeObjectURL(e)}static async load(e){let t=this.createTempURL(e),n=await import(t);if(this.deleteTempUrl(t),n.System)for(let i of Object.keys(p))n.System[i]=p[i];if(n.Input)for(let i of Object.keys(E))n.Input[i]=E[i];if(n.Metadata){f.importFrom(n.Metadata);for(let i of Object.keys(f))n.Metadata[i]=f[i]}return n}};var k=class r{static{c(this,"Builder")}static tab;static compiled;constructor(){}static async compile(e=!0,t){let n=await h.getAllTextFiles(h.folderHandle),i=n.files,s=n.assets;for(let{fileHandle:o,path:a}of i){let d=await(await o.getFile()).text();x.files.set(a,d)}try{let o=(await x.bundle(t)).outputFiles[0]?.text;if(!o)return!1;this.compiled=o,u.assetsWindow.clearAssets();for(let a of s)u.assetsWindow.addAsset(a);return!0}catch(o){return e&&v.notify(`${o}`,"danger",15e3),!1}}static async build(){if(!h.folderHandle)return v.notify("Open project first.","danger"),!1;let e=await h.folderHandle.getDirectoryHandle("build",{create:!0}),n=await(await h.folderHandle.getFileHandle("project.gz")).getFile(),i=new DecompressionStream("gzip"),s=await new Response(n.stream().pipeThrough(i)).arrayBuffer(),o=new TextDecoder().decode(s);if(x.files.clear(),x.files.set("index.ts",y.userIndex),x.files.set("main.ts",`import * as index from "./index";
import { Renderer2D } from "@flint/shared/renderer2d";
import { System } from "@flint/runtime/system";
import { ProjectLoader } from "@flint/runtime/project-loader";

System.init(new Renderer2D());

for (const [name, _] of Object.entries(index)) {
    const value = index[name];
    System.components.set(name, value as any);
}
const projectData = ProjectLoader.deserialize(\`${o}\`);

for (const layer of projectData.layers) System.pushLayer(layer);

System.run();
`),await r.compile(!0,"/main.ts")){let a=`<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Build</title></head>
<style>
body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}
canvas {
    position: absolute;
}
#root {
    width: 100%;
    height: 100%;
}
</style>
<body>
<div id="root"></div>
<script>
${r.compiled}
<\/script>
</body>
</html>`,l=await e.getFileHandle("index.html",{create:!0}),d=await l.createWritable();await d.write(a),await d.close();let m=await l.getFile(),T=URL.createObjectURL(m);r.tab&&r.tab.close(),r.tab=window.open(T,"build")}else return!1;return!0}static async buildForEditor(e=!0){if(!h.folderHandle)return v.notify("Open project first.","danger"),!1;if(x.files.clear(),x.files.set("index.ts",y.fullIndex),await r.compile(e)){let t=await K.load(r.compiled);for(let{name:n}of y.config.components){let i=t[n],s=p.components.get(n);if(i&&p.components.set(n,i),!s||!s.prototype)continue;let o=p.components.get(n);if(!o)throw new Error("FLINT PANIC: CRITICAL SYSTEM FAILURE");for(let a of p.layers)for(let l of a.getObjects()){let d=l.getComponent(s);d&&Object.setPrototypeOf(d,o.prototype)}}}else return!1;return!0}};function ae(r,e){if(!(!r||!e))for(let t of Object.keys(r)){let n=r[t],i=e[t];if(!(i==null||typeof i!="object")&&!(n==null||typeof n!="object")){if(Array.isArray(n)&&Array.isArray(i)){for(let s=0;s<n.length;s++){let o=n[s],a=i[0];o&&typeof o=="object"&&a&&typeof a=="object"&&(Object.setPrototypeOf(o,Object.getPrototypeOf(a)),ae(o,a))}continue}Object.setPrototypeOf(n,Object.getPrototypeOf(i)),ae(n,i)}}}c(ae,"restorePrototypesDeep");var V=class{static{c(this,"ProjectLoader")}constructor(){}static deserialize(e){let t=JSON.parse(e),n={layers:[]};for(let i of t.layers){let s=new L;for(let o of i.objects){let a=null,l=[];for(let m of o.components){let T=p.components.get(m.name)||(m.name==="Transform"?D:void 0);if(!T){console.warn(`Component "${m.name}" not registered.`);continue}let O=new T,R=m.data;ae(R,O);let g=new T;Object.assign(g,R),g instanceof D?a=g:l.push(g)}let d=new w(l,a,o.uuid);s.addObject(d)}n.layers.push(s)}return n}static serialize(e){let t={layers:[]};for(let n of e.layers){let i={objects:[]};for(let s of n.getObjects()){let o={uuid:s.uuid,components:[]};for(let a of[s.transform,...s.getAllComponents()]){let l={name:a.constructor.name,data:{}};for(let d of Object.keys(a))d!=="gameObject"&&(l.data[d]=a[d]);o.components.push(l)}i.objects.push(o)}t.layers.push(i)}return JSON.stringify(t)}static load(e){p.layers.length=0;for(let t of e.layers)p.pushLayer(t)}};var ce=class r{static{c(this,"FileTracker")}constructor(){}static timestamps=new Map;static intervalId=null;static debounceTimer=null;static debounceDelay=200;static async startWatchingDirectory(e){this.intervalId===null&&(this.intervalId=setInterval(async()=>{await this.directoryWasUpdated(e)&&this.scheduleRebuild()},this.debounceDelay))}static stopWatching(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null),this.debounceTimer!==null&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}static scheduleRebuild(){this.debounceTimer!==null&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(async()=>{let e=performance.now();await k.buildForEditor(!1);let t=performance.now();r.debounceDelay=t-e,this.stopWatching(),this.startWatchingDirectory(h.folderHandle),this.debounceTimer=null},this.debounceDelay)}static async directoryWasUpdated(e,t=""){let n=!1;for await(let i of e.values()){let s=t?`${t}/${i.name}`:i.name;if(i.kind==="file"){if(s.endsWith("metadata.json"))continue;await this.wasUpdated(s,i)&&(n=!0)}i.kind==="directory"&&await this.directoryWasUpdated(i,s)&&(n=!0)}return n}static async wasUpdated(e,t){let i=(await t.getFile()).lastModified,s=this.timestamps.get(e);return this.timestamps.set(e,i),s!==void 0&&s!==i}},h=class r{static{c(this,"Project")}static folderHandle;static createComponentDialog;static createComponentButton;static createComponentInput;static names=new Map;constructor(){}static{r.createComponentDialog=document.getElementById("create-component-dialog"),r.createComponentButton=r.createComponentDialog.querySelector("sl-button"),r.createComponentButton.addEventListener("click",()=>{r.createComponentDialog.hide(),r.createComponent(r.createComponentInput.value.trim())}),r.createComponentInput=r.createComponentDialog.querySelector("sl-input"),r.createComponentInput.addEventListener("sl-input",()=>{r.createComponentButton.disabled=r.createComponentInput.value.trim()===""})}static async run(){return await r.saveProject(),await k.buildForEditor()}static async stop(){let e=await r.loadProject();return u.hierarchyWindow.onUpdate(),u.inspectorWindow.currentObject&&(u.inspectorWindow.currentObject=p.getGameObjectById(u.inspectorWindow.currentObject.uuid)),e}static async openProject(e){await r.startupProject(e),await r.loadProject(),u.hierarchyWindow.onUpdate(),setInterval(async()=>{await r.saveProject()},6e4)}static async newProject(e){(await r.startupProject(e)||!await r.loadProject())&&(p.pushLayer(u.defaultLayer),u.hierarchyWindow.onUpdate()),await r.saveProject(),u.hierarchyWindow.onUpdate(),setInterval(async()=>{await r.saveProject()},6e4)}static async buildAndRun(){return await k.build()}static async saveProject(){let e=V.serialize({layers:p.layers}),t=new Blob([e],{type:"text/plain"}),n=new CompressionStream("gzip"),i=new Response(t.stream().pipeThrough(n)),o=await(await r.folderHandle.getFileHandle("project.gz",{create:!0})).createWritable();await o.write(await i.arrayBuffer()),await o.close()}static async loadProject(){try{let t=await(await r.folderHandle.getFileHandle("project.gz")).getFile(),n=new DecompressionStream("gzip"),i=await new Response(t.stream().pipeThrough(n)).arrayBuffer(),s=new TextDecoder().decode(i),o=V.deserialize(s);return V.load(o),!0}catch(e){return console.log("could not load the project:",e),!1}}static async startupProject(e){r.folderHandle=e;let t=await y.ensureLoaded();await r.getAllTextFiles(r.folderHandle);try{await e.getDirectoryHandle("flint")}catch{u.loadingDialogProgressBar.value=0,u.loadingDialogProgressBar.indeterminate=!1,u.loadingDialog.show(),await r.copyTypesToDirectory(e,window.location.href.replace(/index\.html$/,"")+"/types/",(n,i)=>{u.loadingDialogProgressBar.value=i/n*100})}return await f.loadFromFile(r.folderHandle),await f.saveToFile(r.folderHandle),await k.buildForEditor(),u.loadingDialog.hide(),await ce.startWatchingDirectory(r.folderHandle),t}static async getAllTextFiles(e,t=""){let n=[],i=[];for await(let[s,o]of e.entries())if(o.kind==="file"&&(s.endsWith(".ts")||s.endsWith(".json")))i.push({id:crypto.randomUUID(),name:s,type:s.split(".").pop()==="ts"?"component":"json",path:"/"+t+s}),n.push({fileHandle:o,path:t+s});else if(o.kind==="directory"){i.push({id:crypto.randomUUID(),name:s,type:"folder",path:"/"+t+s});let a=(await r.getAllTextFiles(o,t+s+"/")).files;n.push(...a)}return{files:n,assets:i}}static async openInFileEditor(e){if(!y.config.rootPath){let t=prompt("Due to browser restrictions - to open file in VSCode enter absolute path to your project folder:","C:/path/to/your/project/folder");if(!t)return;y.config.rootPath=t,await y.save()}window.location.href="vscode://file/"+y.config.rootPath+e}static showCreateComponentWindow(){r.createComponentButton.disabled=!0,r.createComponentInput.value="",r.createComponentDialog.show()}static async createComponent(e){e=j.joinToPascalCase(e);let t=j.splitPascalCase(e,"-"),n=u.assetsWindow.currentPath.replace(/^\//,""),i=`${n}/${t}.ts`,s=`import Component from "@flint/runtime/component";

export class ${e} extends Component {
    start() {
        // Code that should run once on start
    }

    update() {
        // Code that should run every frame
    }
}
`,o=r.folderHandle,a=n.split("/").filter(Boolean);for(let m of a)o=await o.getDirectoryHandle(m,{create:!0});let d=await(await o.getFileHandle(t+".ts",{create:!0})).createWritable();await d.write(s),await d.close(),u.assetsWindow.addAsset({id:crypto.randomUUID(),name:t+".ts",type:"component",path:i,data:e}),y.config.components.push({name:e,file:i}),await y.save(),await r.openInFileEditor("/"+i)}static async deleteComponent(e){let t=j.splitPascalCase(e,"-"),n=u.assetsWindow.currentPath.replace(/^\//,""),i=`${n}/${t}.ts`,s=r.folderHandle,o=n.split("/").filter(Boolean);for(let a of o)if(s=await s.getDirectoryHandle(a,{create:!1}),!s)return;try{await s.removeEntry(t+".ts")}catch(a){console.warn("File not found:",a)}y.config.components.splice(y.config.components.findIndex(a=>a.name===e),1),await y.save(),u.assetsWindow.removeAsset(i)}static async copyTypesToDirectory(e,t,n){let i=await fetch(t+"files.json").then(l=>l.json()),s=[...i.types||[],...i.json||[]],o=[],a=0;for(let l of s)o.push((async()=>{let d=t+l,m;l.endsWith("d.ts")?m=await fetch(d):m=await fetch(t.replace("types/","src/")+l);let T=await m.text(),O=l.split("/"),R=O.pop(),g=e;for(let oe of O)g=await g.getDirectoryHandle(oe,{create:!0});let G=await(await g.getFileHandle(R,{create:!0})).createWritable();await G.write(T),await G.close(),n&&n(s.length,++a)})());await Promise.all(o),console.log("All type/json files copied!")}};var y=class r{static{c(this,"ProjectConfig")}static configFileName="project-config.json";static config;static index='export * from "@flint/runtime/system";export { default as Input } from "@flint/shared/input";export { default as Metadata } from "@flint/shared/metadata";';static get fullIndex(){return r.index+r.config.components.map(e=>`export * from "./${e.file}";`).join("")}static get userIndex(){return r.config.components.map(e=>`export * from "./${e.file}";`).join("")}static tsConfig=`{
    "compilerOptions": {
        "baseUrl": ".",
        "paths": {
            "@flint/*": [
                "flint/*"
            ]
        },
        "experimentalDecorators": true,
        "emitDecoratorMetadata": true,
    }
}`;static defaultConfig={components:[]};static async save(){let t=await(await h.folderHandle.getFileHandle(r.configFileName,{create:!0})).createWritable();await t.write(JSON.stringify(r.config,null,4)),await t.close()}static async load(){try{let n=await(await(await h.folderHandle.getFileHandle(r.configFileName)).getFile()).text();this.config=JSON.parse(n);let s=await(await h.folderHandle.getFileHandle("tsconfig.json")).getFile();return r.tsConfig=await s.text(),!0}catch{return!1}}static async create(){let t=await(await h.folderHandle.getFileHandle(r.configFileName,{create:!0})).createWritable();await t.write(JSON.stringify(r.defaultConfig,null,4)),await t.close();let i=await(await h.folderHandle.getFileHandle("tsconfig.json",{create:!0})).createWritable();await i.write(r.tsConfig),await i.close()}static async ensureLoaded(){return await r.load()?!1:(await r.create(),r.config=r.defaultConfig,!0)}};var x=class r{static{c(this,"Bundler")}static files=new Map;static flintFiles=new Map;static esbuild;static virtualFsPlugin={name:"virtual-fs",setup(e){e.onResolve({filter:/.*/},t=>{let n=t.path.endsWith(".ts")||t.path.endsWith(".json")?t.path:t.path+".ts";if(n.startsWith("@flint"))return{path:n,namespace:"virtual"};let i=t.importer?t.importer.replace(/\/[^/]*$/,""):t.resolveDir;i=i.replace(/\\/g,"/");let s=i.split("/").filter(Boolean),o=n.split("/").filter(Boolean),a=[];if(!i.includes(".")&&(n.startsWith("./")||n.startsWith("../"))){a.push(...s);for(let d of o)d!=="."&&(d===".."?a.pop():a.push(d))}else a.push(...o);let l=a.join("/");return{path:l.startsWith(".")?l.slice(2,l.length):l,namespace:"virtual"}}),e.onLoad({filter:/.*/,namespace:"virtual"},t=>{if(t.path.startsWith("@flint")){let s="flint/"+t.path.replace("@flint/",""),o=r.flintFiles.get(s);return o?{contents:o,loader:s.endsWith(".ts")?"ts":"json"}:(console.warn("Missing virtual flint file:",s),{contents:"export {}",loader:s.endsWith(".json")?"json":"ts"})}let n=t.path,i=r.files.get(n);if(!i){let s=r.flintFiles.get(n);return s?{contents:s,loader:n.endsWith(".ts")?"ts":"json"}:(console.warn("Missing virtual file:",n),{contents:"export {}",loader:"ts"})}return{contents:i,loader:n.endsWith(".ts")?"ts":"json"}})}};constructor(){}static async init(){if(!r.esbuild){let{default:e}=await import("https://esm.sh/esbuild-wasm@0.19.12");await e.initialize({wasmURL:"https://esm.sh/esbuild-wasm@0.19.12/esbuild.wasm"}),r.esbuild=e}return r}static async bundle(e="/index.ts"){return await r.esbuild.build({entryPoints:[e],bundle:!0,write:!1,format:"esm",target:["esnext"],plugins:[r.virtualFsPlugin],external:["@flint/"],minify:!0,keepNames:!0,tsconfigRaw:y.tsConfig})}};var q=class{static{c(this,"Assets")}element;gridElement;contextDropdownElement;contextMenuElement;cachedWidth=0;cachedHeight=0;allAssets=[];currentPath="/";backButton;constructor(e,t){this.element=e,this.gridElement=t,this.contextDropdownElement=this.element.querySelector("#assets-context-dropdown"),this.contextMenuElement=this.contextDropdownElement.querySelector("#assets-context-menu"),this.backButton=document.getElementById("assets-back-button"),this.setupButtons(),this.setupContextMenu(),this.renderCurrentFolder()}setupButtons(){[{id:"new-folder-button",type:"folder",label:"New Folder"},{id:"new-json-button",type:"json",label:"New JSON"}].forEach(({id:t,type:n,label:i})=>{document.getElementById(t).addEventListener("click",()=>{let o=this.allAssets.filter(l=>l.path.startsWith(this.currentPath+"/")&&l.type===n).length+1,a={id:crypto.randomUUID(),name:`${i} ${o}`,type:n,path:`${this.currentPath}${this.currentPath==="/"?"":"/"}${i} ${o}`,data:""};this.addAsset(a)})}),document.getElementById("new-component-button").addEventListener("click",()=>{h.showCreateComponentWindow()}),this.backButton.addEventListener("click",()=>{this.goBack(),this.updateBackButton()}),this.updateBackButton()}updateBackButton(){this.backButton.disabled=this.currentPath==="/"}goBack(){if(this.currentPath==="/")return;let e=this.currentPath.split("/").filter(Boolean);e.pop(),this.currentPath="/"+e.join("/"),this.currentPath===""&&(this.currentPath="/"),this.renderCurrentFolder()}setupContextMenu(){this.contextDropdownElement.addEventListener("sl-after-show",()=>{this.cachedWidth===0&&(this.cachedWidth=this.contextMenuElement.clientWidth,this.cachedHeight=this.contextMenuElement.clientHeight)}),this.element.addEventListener("contextmenu",e=>{e.preventDefault(),this.contextDropdownElement.show(),this.cachedWidth===0?(this.positionDropdown(e),this.contextDropdownElement.addEventListener("sl-after-show",()=>this.positionDropdown(e),{once:!0})):this.positionDropdown(e)})}positionDropdown(e){let t=Math.min(document.body.clientWidth-this.cachedWidth,e.pageX),n=Math.min(document.body.clientHeight-this.cachedHeight,e.pageY);Object.assign(this.contextDropdownElement.style,{left:`${t}px`,top:`${n}px`}),this.contextDropdownElement.reposition()}addAsset(e){this.allAssets.push(e),this.renderCurrentFolder()}removeAsset(e){this.allAssets=this.allAssets.filter(t=>!t.path.startsWith(e)),this.renderCurrentFolder()}clearAssets(){this.allAssets=[],this.renderCurrentFolder()}renderCurrentFolder(){this.gridElement.innerHTML="";let e=this.currentPath==="/"?"/":this.currentPath+"/";this.allAssets.filter(n=>{let i=n.path.replace(e,"");return n.path.startsWith(e)&&!i.includes("/")}).sort((n,i)=>{let s=c(d=>d.type==="folder"?0:d.path.endsWith(".json")?2:1,"typeOrder"),o=s(n)-s(i);if(o!==0)return o;let a=n.name.toLowerCase(),l=i.name.toLowerCase();return a<l?-1:a>l?1:0}).forEach(n=>this.renderAsset(n)),this.updateBackButton()}getIconForType(e){return e==="folder"?"folder2":e==="component"?"code-slash":e==="json"?"text-left":"file"}renderAsset(e){let t=document.createElement("div");t.className="asset-card",t.draggable=!0,t.dataset.path=e.path,t.innerHTML=`
            <sl-card class="asset-card-inner">
                <sl-icon name="${this.getIconForType(e.type)}" class="asset-icon"></sl-icon>
                <span class="asset-name">${e.name}</span>
            </sl-card>
        `;let n=t.querySelector(".asset-name");if(e.type!=="folder"){let s=function(o){o.dataTransfer.items.add(e.data,"text/plain")};var i=s;if(c(s,"dragstartHandler"),e.type==="component"&&e.data===void 0){let o=y.config.components.find(a=>a.file===e.path)?.name;o&&(e.data=o)}t.addEventListener("dragstart",s)}t.addEventListener("dblclick",async()=>{e.type==="folder"?this.enterFolder(e.path):await this.onAssetOpen(e)}),this.setupAssetNameEdit(n,e),this.gridElement.appendChild(t)}setupAssetNameEdit(e,t){}enterFolder(e){this.currentPath=e,this.renderCurrentFolder()}async onAssetOpen(e){e.type!=="folder"&&await h.openInFileEditor(e.path)}};function J(r){return e=>{typeof e=="function"?f.setClass(e.prototype,"editor-name",r):f.setClass(e,"editor-name",r)}}c(J,"editorName");var X=class{static{c(this,"Hierarchy")}element;layers=new Map;selection;selectedElement;contextDropdownElement;contextMenuElement;cachedWidth=0;cachedHeight=0;deleteButton;constructor(e){this.element=e,this.element.addEventListener("sl-selection-change",this.onSelectionChange.bind(this)),this.contextDropdownElement=this.element.parentElement.querySelector("#hierarchy-context-dropdown"),this.contextMenuElement=this.contextDropdownElement.querySelector("#hierarchy-context-menu"),this.deleteButton=this.contextMenuElement.querySelector("#delete-button"),this.setupContextMenu()}setupContextMenu(){this.contextDropdownElement.addEventListener("sl-after-show",()=>{this.cachedWidth===0&&(this.cachedWidth=this.contextMenuElement.clientWidth,this.cachedHeight=this.contextMenuElement.clientHeight)}),this.element.parentElement.addEventListener("contextmenu",e=>{e.preventDefault(),this.contextDropdownElement.show(),e.target===this.element.parentElement||e.target===this.element||e.target!==this.selectedElement?this.deleteButton.style.display="none":this.deleteButton.style.display="block",this.cachedWidth===0?(this.positionDropdown(e),this.contextDropdownElement.addEventListener("sl-after-show",()=>this.positionDropdown(e),{once:!0})):this.positionDropdown(e)}),this.contextMenuElement.querySelector("#new-layer-button").addEventListener("click",()=>{let e=new L;p.pushLayer(e),this.onUpdate()}),this.contextMenuElement.querySelector("#new-gameobject-button").addEventListener("click",()=>{this.createObject()}),this.contextMenuElement.querySelector("#delete-button").addEventListener("click",()=>{this.deleteSelected()})}positionDropdown(e){let t=Math.min(document.body.clientWidth-this.cachedWidth,e.pageX),n=Math.min(document.body.clientHeight-this.cachedHeight,e.pageY);Object.assign(this.contextDropdownElement.style,{left:`${t}px`,top:`${n}px`}),this.contextDropdownElement.reposition()}onSelectionChange(e){let t=e.detail.selection;this.selectedElement=t[0];let n=t[0].hierarchyId.split("-").map(s=>Number.parseInt(s)),i=this.layers.get(n[0]??0);if(n[1]?this.selection=i?.getObjects()[n[1]]:this.selection=i,!this.selection)throw new Error("Failed to get 'selection'")}createObject(){if(this.selection)this.selection instanceof L?this.selection.addObject(new w):this.selection.layer.addObject(new w);else{if(p.layers.length===0){v.notify("GameObject can be created only inside a Layer.","danger");return}p.layers[0].addObject(new w)}this.onUpdate()}deleteSelected(){this.selection&&(this.selection instanceof w?this.selection.layer.removeObject(this.selection):p.removeLayer(this.selection),u.hierarchyWindow.onUpdate())}async onUpdate(){this.layers.clear(),this.element.innerHTML="";for(let t=p.layers.length-1;t>=0;t--){let n=p.layers[t],i=f.getClass(n,"editor-name")??`new Layer${t>0?" "+t:""}`,s=this.addItem(i,t.toString(),this.element),o=n.getObjects();for(let a=o.length-1;a>=0;a--){let l=f.getClass(o[a],"editor-name")??`new GameObject${a>0?" "+a:""}`;this.addItem(l,`${t}-${a}`,s)}this.layers.set(t,n)}document.querySelectorAll("sl-tree-item").forEach(t=>{t.addEventListener("dblclick",async()=>{if(t.querySelector("sl-input"))return;let n=Array.from(t.childNodes).find(a=>a.nodeType===Node.TEXT_NODE);n||(n=document.createTextNode(""),t.prepend(n));let i=n.textContent||"",s=document.createElement("sl-input");s.type="text",s.value=i,s.style.width="100%",n.textContent="",t.appendChild(s),await customElements.whenDefined("sl-input"),s.focus(),s.select();let o=c(a=>{n.textContent=a&&s.value||i;let l=t.hierarchyId;if(l){l=l.split("-").map(T=>Number.parseInt(T));let m=u.hierarchyWindow.layers.get(l[0]??0)?.getObjects()[l[1]??0];f.setClass(m,"inspector-name",n.textContent)}s.remove()},"exitEdit");s.addEventListener("sl-blur",()=>o(!0)),s.addEventListener("keydown",a=>{a.key==="Enter"&&o(!0),a.key==="Escape"&&o(!1)})})})}addItem(e,t,n){let i=Object.assign(document.createElement("sl-tree-item"),{textContent:e,hierarchyId:t,expanded:!0});return n.appendChild(i),i}};var le=class{static{c(this,"InspectorComponent")}element;component;constructor(e){this.component=e,this.element=Object.assign(document.createElement("sl-details"),{summary:e.constructor.name,open:!0}),this.generateContent()}generateContent(){this.element.appendChild(j.build(this.component))}},Y=class{static{c(this,"Inspector")}minSize=new b(250,100);currentObject;components=[];dropTarget=null;element;dialog;dialogSelect;addComponentButton;dialogAddButton;constructor(e,t){this.element=e,this.dialog=t,this.dropTarget=document.getElementById("inspector-drop-target"),this.dropTarget.addEventListener("dragover",n=>{n.preventDefault()}),this.dropTarget.addEventListener("drop",n=>{n.preventDefault(),n.dataTransfer.items[0]?.getAsString(i=>{this.currentObject?.addComponent(new(p.components.get(i)))})}),this.dialogSelect=this.dialog.getElementsByTagName("sl-select")[0],this.dialogAddButton=this.dialog.getElementsByTagName("sl-button")[0],u.hierarchyWindow.element.addEventListener("sl-selection-change",this.onEvent.bind(this)),this.addComponentButton=document.getElementById("add-component-button"),this.addComponentButton.addEventListener("click",this.addComponent.bind(this)),this.dialogSelect.addEventListener("sl-change",()=>{this.dialogAddButton.disabled=!1}),this.dialogAddButton.addEventListener("click",()=>{if(this.dialog.hide(),this.currentObject){let n=p.components.get(this.dialogSelect.value);if(!n)return;this.currentObject.addComponent(new n)}})}async addComponent(){if(!this.currentObject){v.notify("Select object first.","primary");return}this.dialogAddButton.disabled=!0,this.dialogSelect.innerHTML="";for(let[e,t]of p.components)t.name!==void 0&&this.dialogSelect.appendChild(Object.assign(document.createElement("sl-option"),{value:t.name,textContent:j.splitPascalCase(t.name)}));this.dialogSelect.value="",this.dialog.show()}addInspectorComponent(e){let t=new le(e);this.element.appendChild(t.element),this.components.push(t)}onEvent(e){let n=e.detail.selection[0].hierarchyId.split("-").map(s=>Number.parseInt(s));if(n.length!==2)return;let i=u.hierarchyWindow.layers.get(n[0]??0);if(this.currentObject=i?.getObjects()[n[1]??0],!this.currentObject)throw new Error("Failed to get 'currentObject'");this.element.innerHTML="",this.addComponentButton.style.display="initial",j.clearFields(),this.components=[],this.addInspectorComponent(this.currentObject.transform);for(let s of this.currentObject.getAllComponents())this.addInspectorComponent(s)}componentsMatch(){if(!this.currentObject)return!1;let e=[this.currentObject.transform,...this.currentObject.getAllComponents()];if(e.length!==this.components.length)return!1;for(let t=0;t<e.length;t++)if(this.components[t].component!==e[t])return!1;return!0}update(){if(this.currentObject){if(!this.componentsMatch()){this.element.innerHTML="",j.clearFields(),this.components=[],this.addInspectorComponent(this.currentObject.transform);for(let e of this.currentObject.getAllComponents())this.addInspectorComponent(e)}j.updateFields()}}};var v=class{static{c(this,"Notifier")}static escapeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}static async notify(e,t,n=4e3){let i={primary:"info-circle",success:"check2-circle",neutral:"gear",warning:"exclamation-triangle",danger:"exclamation-octagon"},s=Object.assign(document.createElement("sl-alert"),{countdown:"ltr",variant:t,closable:!0,duration:n,innerHTML:`
        <sl-icon name="${i[t]}" slot="icon"></sl-icon>
        ${this.escapeHtml(e)}
      `});document.body.append(s),await customElements.whenDefined("sl-alert"),s.toast()}},F=class{static{c(this,"ToolBarActions")}constructor(){}static async newProject(){await h.newProject(await window.showDirectoryPicker({mode:"readwrite",id:"project"})),u.onProjectLoad(),v.notify("Project created successfully.","success")}static async openProject(){await h.openProject(await window.showDirectoryPicker({mode:"readwrite",id:"project"})),u.onProjectLoad(),v.notify("Project loaded successfully.","success")}static async saveProject(){try{await h.saveProject(),v.notify("Project saved successfully.","success")}catch(e){v.notify("Could not save the project: "+e,"warning")}}static async buildAndRun(){await h.saveProject(),await h.buildAndRun()&&v.notify("Project builded successfully.","success")}static async runProject(){let e=u.runButtonIcon.name==="play";u.runButtonIcon.name=e?"stop":"play",e?await h.run()&&(p.run(),v.notify("Project started.","primary")):await h.stop()&&(p.runRenderingOnly(),v.notify("Project stopped.","primary"))}},u=class r{static{c(this,"Editor")}static draggedItem;static hierarchyWindow;static inspectorWindow;static assetsWindow;static runButton;static runButtonIcon;static loadingDialog;static loadingDialogProgressBar;static _defaultLayer;static get defaultLayer(){return this._defaultLayer}static _running=!1;static get running(){return this._running}constructor(){}static init(){x.init();try{let n=document.getElementById("add-component-dialog");r.hierarchyWindow=new X(document.getElementById("hierarchy-tree")),r.inspectorWindow=new Y(document.getElementById("inspector-body"),n),r.assetsWindow=new q(document.getElementById("assets-window"),document.getElementById("assets-grid")),r.loadingDialog=document.getElementById("loading-dialog"),r.loadingDialog.addEventListener("sl-request-close",function(i){i.detail.source==="overlay"&&i.preventDefault()}),r.loadingDialogProgressBar=r.loadingDialog.querySelector("sl-progress-bar"),document.getElementById("new-project-button").addEventListener("click",F.newProject),document.getElementById("open-project-button").addEventListener("click",F.openProject),document.getElementById("save-project-button").addEventListener("click",F.saveProject),document.addEventListener("keydown",async function(i){i.ctrlKey&&i.code==="KeyS"&&(i.preventDefault(),i.stopImmediatePropagation(),await F.saveProject())},!0),document.getElementById("build-and-run-button").addEventListener("click",F.buildAndRun),document.addEventListener("keydown",async function(i){i.ctrlKey&&i.code==="KeyB"&&(i.preventDefault(),i.stopImmediatePropagation(),await F.buildAndRun())},!0),this.runButton=document.getElementById("run-button"),this.runButton.addEventListener("click",F.runProject),this.runButtonIcon=this.runButton.querySelector("sl-icon"),document.getElementById("create-object-button").addEventListener("click",r.hierarchyWindow.createObject.bind(r.hierarchyWindow))}catch(n){console.error(`Error: Failed to initialize UI: ${n}`)}r.hierarchyWindow.onUpdate(),r.updateInspectorFields(),r.loadEngineFiles(),r._defaultLayer=new L;let e=new w([new S],new D(void 0,new b(100,100)));J("Rect")(e);let t=new w([new P]);J("Camera")(t),r._defaultLayer.addObjects([e,t]),J("New Layer")(L),J("New GameObject")(w)}static async loadEngineFiles(){let e=await fetch(window.location.href.replace(/index\.html$/,"")+"/types/files.json").then(s=>s.json()),t=window.location.href.replace(/index\.html$/,"")+"/src/",n=[...e.types||[],...e.json||[]],i=[];for(let s of n)i.push((async()=>{let o=s.replace("d.ts","ts"),a=t+o,l=await fetch(a).then(d=>d.text());x.flintFiles.set(o,l)})());await Promise.all(i),console.log("All flint files loaded")}static updateInspectorFields(){r.inspectorWindow.update(),requestAnimationFrame(r.updateInspectorFields)}static onProjectLoad(){r.runButton.disabled=!1}};p.init(new Q);p.runRenderingOnly();u.init();})();
