"use strict";(()=>{var pe=Object.create;var Y=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var me=Object.getPrototypeOf,he=Object.prototype.hasOwnProperty;var c=(r,e)=>Y(r,"name",{value:e,configurable:!0}),fe=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var ye=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ue(e))!he.call(r,i)&&i!==t&&Y(r,i,{get:()=>e[i],enumerable:!(n=ce(e,i))||n.enumerable});return r};var ge=(r,e,t)=>(t=r!=null?pe(me(r)):{},ye(e||!r||!r.__esModule?Y(t,"default",{value:r,enumerable:!0}):t,r));var M=(r,e,t,n)=>{for(var i=n>1?void 0:n?ce(e,t):e,o=r.length-1,s;o>=0;o--)(s=r[o])&&(i=(n?s(e,t,i):s(i))||i);return n&&i&&Y(e,t,i),i};var Z=class{static{c(this,"Renderer2D")}canvas;ctx;_fontSize=18;_fontStyle="Arial";setCanvas(e,t){this.canvas=e,this.ctx=t,this.updateFont()}set fillColor(e){this.ctx.fillStyle=e}set lineColor(e){this.ctx.strokeStyle=e}set lineWidth(e){this.ctx.lineWidth=e}set lineJoin(e){this.ctx.lineJoin=e}set shadowColor(e){this.ctx.shadowColor=e}set shadowBlur(e){this.ctx.shadowBlur=e}set textBaseLine(e){this.ctx.textBaseline=e}set textAlign(e){this.ctx.textAlign=e}set fontSize(e){this._fontSize=e,this.updateFont()}set fontStyle(e){this._fontStyle=e,this.updateFont()}resetTransform(){this.ctx.resetTransform()}translate(e){this.ctx.translate(e.x,e.y)}rotate(e){this.ctx.rotate(e)}updateFont(){this.ctx.font=this._fontSize.toString()+"px "+this._fontStyle}clearCanvas(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}fillCanvas(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}fillRect(e,t){this.ctx.fillRect(e.x,e.y,t.x,t.y)}strokeRect(e,t){this.ctx.strokeRect(e.x-this.ctx.lineWidth/2,e.y-this.ctx.lineWidth/2,t.x+this.ctx.lineWidth,t.y+this.ctx.lineWidth)}fillText(e,t){this.ctx.fillText(t,e.x,e.y)}strokeText(e,t){this.ctx.strokeText(t,e.x,e.y)}makePath(e){this.ctx.beginPath();let t=e[0];t&&this.ctx.moveTo(t.x,t.y);for(let n=1;n<e.length;++n){let i=e[n];i&&this.ctx.lineTo(i.x,i.y)}this.ctx.closePath()}fillPolygon(e){this.makePath(e),this.ctx.fill()}strokePolygon(e){this.makePath(e),this.ctx.stroke()}};var b=class r{static{c(this,"Vector2D")}static zero=new r;x;y=0;constructor(e=0,t){this.x=e,t!==void 0?this.y=t:this.y=e}set(e,t){return this.x=e,this.y=t,this}copy(){return new r(this.x,this.y)}add(e){return new r(this.x+e.x,this.y+e.y)}subtract(e){return new r(this.x-e.x,this.y-e.y)}multiply(e){return e instanceof r?new r(this.x*e.x,this.y*e.y):new r(this.x*e,this.y*e)}divide(e){return e instanceof r?new r(this.x/e.x,this.y/e.y):new r(this.x/e,this.y/e)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(e=1){let t=this.magnitude();return t===0?new r(0,0):new r(this.x/t*e,this.y/t*e)}clamp(e,t){return new r(Math.max(e.x,Math.min(t.x,this.x)),Math.max(e.y,Math.min(t.y,this.y)))}};var E=class r{static{c(this,"Input")}static pressedKeys=new Set;static pressedMouseButtons=new Set;static inputAxes=[];static mousePosition=new b(window.innerWidth/2,window.innerHeight/2);constructor(){}static get pressedKeyCount(){return r.pressedKeys.size}static isKeyPressed(e){return this.pressedKeys.has(e)}static isMouseButtonPressed(e){return this.pressedMouseButtons.has(e)}static getAxis(e){let t=this.inputAxes.find(n=>n.name===e);if(!t)throw new Error(`InputAxis with name ${e} does not exist!`);return t.value}static init(){document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),document.addEventListener("mousedown",this.onMouseDown.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),document.addEventListener("touchstart",this.onMouseMove.bind(this)),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("touchmove",this.onMouseMove.bind(this))}static onKeyDown(e){this.pressedKeys.add(e.code),this.updateInputAxes()}static onKeyUp(e){this.pressedKeys.delete(e.code),this.updateInputAxes()}static onMouseDown(e){this.pressedMouseButtons.add(e.button),this.updateInputAxes()}static onMouseUp(e){this.pressedMouseButtons.delete(e.button),this.updateInputAxes()}static onMouseMove(e){e instanceof MouseEvent?this.mousePosition.set(e.pageX,e.pageY):e.touches[0]&&this.mousePosition.set(e.touches[0].pageX,e.touches[0].pageY)}static updateInputAxes(){for(let e of this.inputAxes)e.update()}};var k=class{static{c(this,"SystemEvent")}_type;stopNextLayer=!1;stopImmediate=!1;get type(){return this._type}constructor(e){this._type=e}stopPropagationToNextLayer(){this.stopNextLayer=!0}stopImmediatePropagation(){this.stopImmediate=!0}},W=class{static{c(this,"SystemEventEmitter")}listeners=[];reversed;stopImmediate;constructor(e=!1,t=!1){this.reversed=t,this.stopImmediate=e}addEventListener(e){this.reversed?this.listeners.unshift(e):this.listeners.push(e)}dispatchEvent(e){for(let t=0;t<this.listeners.length;++t){let n=this.listeners[t];if(!n)return!0;if(n(e),this.stopImmediate){if(e.stopImmediate)return e.stopPropagationToNextLayer(),!1;if(e.stopNextLayer)return!1}}return!0}removeEventListener(e){let t=this.listeners.indexOf(e);t!=-1&&this.listeners.splice(t,1)}};var le={input:[{name:"horizontal",bindings:[{value:-1,keys:[{type:"keyboard",code:["KeyA","ArrowLeft"]}]},{value:1,keys:[{type:"keyboard",code:["KeyD","ArrowRight"]}]}]},{name:"vertical",bindings:[{value:-1,keys:[{type:"keyboard",code:["KeyW","ArrowUp"]}]},{value:1,keys:[{type:"keyboard",code:["KeyS","ArrowDown"]}]}]}]};var N=class{static{c(this,"InputAxis")}name;bindings;_value=0;get value(){return this._value}constructor(e,t){this.name=e,t?this.bindings=new Set(t):this.bindings=new Set}addBinding(e){this.bindings.add(e)}removeBinding(e){this.bindings.delete(e)}update(){this._value=0;for(let e of this.bindings)for(let t of e.keys)this.isKeyActive(t)&&(this._value+=e.value);this._value=Math.max(-1,Math.min(1,this._value))}isKeyActive(e){for(let t of e.code)switch(e.type){case"keyboard":if(E.isKeyPressed(t.toString()))return!0;break;case"mouse":if(E.isMouseButtonPressed(+t))return!0;break;case"gamepad":new Error('Input device "Gamepad" is not implemented.');break}}};var U=class{static{c(this,"NumberRenderer")}canRender(e){return e==="number"}render(e,t,n,i){this.update=()=>{let l=a(o.get(),6).toString();s.value!==l&&(s.value=l)};let o={get:c(()=>n(e,t),"get"),set:c(l=>i(e,t,l),"set"),update:this.update},s=document.createElement("sl-input");s.type="number",s.step=10,s.addEventListener("sl-input",l=>{let d=parseFloat(l.target.value);Number.isNaN(d)||o.set(d),l.target.value===""&&o.set(0)});function a(l,d){let m=Math.pow(10,d);return Math.round(l*m)/m}c(a,"roundUpTo");for(let l of C.getBehaviors("number"))l.attach(s,o);return o.update(),s}update(){}};var Q=class{static{c(this,"WheelScrubBehavior")}speed=.5;shiftMult=8;ctrlMult=.1;attach(e,t){let n=c(i=>{if(document.activeElement!=e)return;i.preventDefault();let o=i.deltaY*-.1;o*=this.speed,i.shiftKey&&(o*=this.shiftMult),i.ctrlKey&&(o*=this.ctrlMult);let s=(parseFloat(e.value)||0)+o;t.set(s),t.update()},"handleWheel");e.addEventListener("wheel",n,{passive:!1})}};var _=class{static{c(this,"DragScrubBehavior")}dragSpeed=.5;shiftMult=8;ctrlMult=.1;attach(e,t){let n=!1,i=0,o=!1,s=!1,a=4,l=3,d=0,m=!1,T=c(g=>g<=a||g>=window.innerWidth-a,"shouldLockPointer"),R=c(g=>{if(!n)return;if(!m){let re=g.clientX-d;if(Math.abs(re)<l)return;m=!0}if(!o&&T(g.clientX)){o=!0,s=!0,e.requestPointerLock();return}if(o&&s){s=!1;return}let $=g.movementX;$*=this.dragSpeed,g.shiftKey&&($*=this.shiftMult),g.ctrlKey&&($*=this.ctrlMult);let V=i+$;i=V,t.set(V),t.update()},"handleMouseMove"),O=c(()=>{n=!1,m=!1,o&&(o=!1,document.exitPointerLock()),window.removeEventListener("mousemove",R),window.removeEventListener("mouseup",O)},"stopDragging");e.addEventListener("mousedown",g=>{g.button===0&&(d=g.clientX,i=parseFloat(e.value)||0,m=!1,n=!0,o=!1,s=!1,window.addEventListener("mousemove",R),window.addEventListener("mouseup",O))})}};var ee=class{static{c(this,"ColorRenderer")}canRender(e){return e==="color"}render(e,t,n,i){this.update=()=>{let a=o.get();s.value!==a&&(s.value=a)};let o={get:c(()=>n(e,t),"get"),set:c(a=>i(e,t,a),"set"),update:this.update},s=document.createElement("sl-color-picker");s.noFormatToggle=!0,s.hoist=!0,s.addEventListener("sl-input",a=>o.set(a.target.value));for(let a of C.getBehaviors("color"))a.attach(s,o);return o.update(),s}update(){}};var te=class{static{c(this,"StringRenderer")}canRender(e){return e==="string"}render(e,t,n,i){this.update=()=>{let a=o.get();s.value!==a&&(s.value=a)};let o={get:c(()=>n(e,t),"get"),set:c(a=>i(e,t,a),"set"),update:this.update},s=document.createElement("sl-input");s.addEventListener("sl-input",a=>{o.set(a.target.value)});for(let a of C.getBehaviors("string"))a.attach(s,o);return o.update(),s}update(){}};var f=class r{static{c(this,"Metadata")}static classMeta=new Map;static fieldMeta=new Map;static enabled=!0;static folderHandle=void 0;static setClass(e,t,n){if(!r.enabled)throw new Error("Metadata is disabled");let i=this.classMeta.get(e);i||(i=new Map,this.classMeta.set(e,i)),i.set(t,n),this.changed()}static getClass(e,t){let n=e;for(;n;){let i=this.classMeta.get(n)?.get(t);if(i!==void 0)return i;n=Object.getPrototypeOf(n)}}static setField(e,t,n,i){if(!r.enabled)throw new Error("Metadata is disabled");let o=this.fieldMeta.get(e);o||(o=new Map,this.fieldMeta.set(e,o));let s=o.get(t);s||(s=new Map,o.set(t,s)),s.set(n,i),this.changed()}static getField(e,t,n){let i=e;for(;i;){let s=this.fieldMeta.get(i)?.get(t);if(s?.has(n))return s.get(n);i=Object.getPrototypeOf(i)}}static getFieldAll(e,t){let n=e;for(;n;){let o=this.fieldMeta.get(n)?.get(t);if(o)return o;n=Object.getPrototypeOf(n)}return null}static importFrom(e){for(let[t,n]of e.classMeta){let i=this.classMeta.get(t);i||(i=new Map,this.classMeta.set(t,i));for(let[o,s]of n)i.set(o,s)}for(let[t,n]of e.fieldMeta){let i=this.fieldMeta.get(t);i||(i=new Map,this.fieldMeta.set(t,i));for(let[o,s]of n){let a=i.get(o);a||(a=new Map,i.set(o,a));for(let[l,d]of s)a.set(l,d)}}this.changed()}static changed(){this.folderHandle&&this.saveToFile(this.folderHandle)}static async saveToFile(e){}static async loadFromFile(e){}};var ne=class extends U{static{c(this,"AngleRenderer")}constructor(){super(),this.canRender=e=>e==="angle"}render(e,t,n,i){let o=c((a,l)=>(360+n(a,l)*(180/Math.PI))%360,"newGet"),s=c((a,l,d)=>i(a,l,d%360*(Math.PI/180)),"newSet");return super.render(e,t,o,s)}};var ie=class{static{c(this,"BooleanRenderer")}canRender(e){return e==="boolean"}render(e,t,n,i){this.update=()=>{let a=!!o.get();s.checked!==a&&(s.checked=a)};let o={get:c(()=>n(e,t),"get"),set:c(a=>i(e,t,a),"set"),update:this.update},s=document.createElement("sl-checkbox");s.addEventListener("sl-input",a=>{o.set(!!a.target.checked)});for(let a of C.getBehaviors("string"))a.attach(s,o);return o.update(),s}update(){}};function P(r){return(e,t)=>{f.setField(e,t,"field-renderer",r)}}c(P,"customRenderer");function de(){return(r,e)=>{f.setField(r,e,"hide-in-inspector",!0)}}c(de,"hideInInspector");var F=class{static{c(this,"RendererRegistry")}static renderers=[];static register(e){this.renderers.push(e)}static getRenderer(e){return this.renderers.find(t=>t.canRender(e))}},C=class{static{c(this,"BehaviorRegistry")}static map=new Map;static register(e,t){this.map.has(e)||this.map.set(e,[]),this.map.get(e).push(t)}static getBehaviors(e){return this.map.get(e)??[]}},j=class{static{c(this,"ComponentBuilder")}static fields=[];constructor(){}static get(e,t){let n=e;for(let i of t){if(n==null)return;n=n[i]}return n}static set(e,t,n){if(t.length===0)throw new Error("Path must have at least one element");let i=e;for(let s=0;s<t.length-1;s++){let a=t[s];if(!a)throw new Error("Failed to get key");i[a]==null&&(i[a]={}),i=i[a]}let o=t[t.length-1];if(!o)throw new Error("Path was not found");i[o]=n}static lastKey(e){return e.length>0?e[e.length-1]??"":""}static isPlainObject(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}static splitPascalCase(e,t=" "){let n=/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g,i=e.match(n);return i?i.join(t).toLowerCase():e}static joinToPascalCase(e){return e&&e.replace(/[-_]+/g," ").replace(/\s+/g," ").trim().split(" ").map(n=>n.length===0?n:n[0].toUpperCase()+n.slice(1).toLowerCase()).join("")}static wrapField(e,t){let n=document.createElement("div");n.classList.add("inspector-field");let i=document.createElement("label");return i.classList.add("inspector-label"),i.textContent=this.splitPascalCase(e),n.appendChild(i),n.appendChild(t),n}static label(e){return Object.assign(document.createElement("h4"),{textContent:e})}static field(e,t){let n=this.lastKey(t),i=this.get(e,t),o=typeof i,s=this.get(e,t.slice(0,t.length-1));s||(s=e);let a=f.getField(s,n,"field-renderer"),l=c(d=>{let m=this.wrapField(this.lastKey(t),d.render(e,t,this.get,this.set));return d.update&&this.fields.push({update:d.update}),m},"render");if(a){let d=F.getRenderer(a);if(d)return l(d);let m=document.createElement("span");return m.textContent=`[${a}]`,this.wrapField(n,m)}if(!this.isPlainObject(i)){let d=F.getRenderer(o);if(d)return l(d);let m=document.createElement("span");return m.textContent=`[${o}]`,this.wrapField(n,m)}return this.tree(e,t)}static tree(e,t){let n=this.get(e,t),i=document.createElement("sl-tree-item");i.expanded=!0,i.textContent=this.lastKey(t)||"root";for(let o of Object.keys(n)){if(f.getField(n,o,"hide-in-inspector"))continue;let s=[...t,o],a=this.field(e,s);if(document.createElement("div").appendChild(a),this.isPlainObject(n[o]))i.appendChild(a);else{let d=document.createElement("sl-tree-item");d.classList.add("no-caret"),d.appendChild(a),i.appendChild(d)}}return i}static build(e){let t=document.createElement("sl-tree");for(let n of Object.keys(e)){if(f.getField(e,n,"hide-in-inspector"))continue;let i=[n],o=this.field(e,i);if(o.tagName!=="SL-TREE-ITEM"){let s=document.createElement("sl-tree-item");s.classList.add("no-caret"),s.appendChild(o),t.appendChild(s)}else t.appendChild(o)}return t}static clearFields(){this.fields=[]}static updateFields(){for(let e of this.fields)e.update()}};F.register(new U);F.register(new ee);F.register(new ie);F.register(new te);F.register(new ne);C.register("number",new Q);C.register("number",new _);var H=class{static{c(this,"Component")}parent;get transform(){return this.parent.transform}onAttach(){}onUpdate(){}onRender(e){}swapClass(e){let t=new e;for(let n of Object.keys(this))t[n]=this[n];return t}};M([de()],H.prototype,"parent",2);var I=class extends H{static{c(this,"Camera")}enabled=!0;backgroundColor="#222";get position(){return this.transform.position}get angle(){return this.transform.angle}onAttach(){this.parent.layer.cameras.push(this)}};M([P("color")],I.prototype,"backgroundColor",2);var B=class extends H{static{c(this,"Shape")}fillColor="#cfd2ee";lineColor="#2e69b6";shadowColor="#1c649b";onRender(e){e.fillColor=this.fillColor,e.lineColor=this.lineColor,e.lineWidth=5,e.lineJoin="bevel",e.translate(this.transform.position),e.rotate(this.transform.angle),e.translate(b.zero.subtract(this.transform.position)),e.shadowColor=this.shadowColor,e.shadowBlur=20,e.fillRect(this.transform.position.subtract(this.transform.size.divide(2)),this.transform.size),e.strokeRect(this.transform.position.subtract(this.transform.size.divide(2)),this.transform.size),e.translate(this.transform.position),e.rotate(-this.transform.angle),e.translate(b.zero.subtract(this.transform.position))}};M([P("color")],B.prototype,"fillColor",2),M([P("color")],B.prototype,"lineColor",2),M([P("color")],B.prototype,"shadowColor",2);var p=class r{static{c(this,"System")}static layers=[];static components=new Map;static showColliders=!1;static dpr=window.devicePixelRatio||1;static lastFrame;static _deltaTime;static rootDiv;static renderingContext=CanvasRenderingContext2D;static _renderer;static eventEmitter=new W(!1,!0);static _runningState=0;static get isRunning(){return r._runningState}static get deltaTime(){return this._deltaTime}static get fps(){return 1/this._deltaTime}static get renderer(){return this._renderer}static setCursor(e){r.rootDiv.style.cursor=e}constructor(){}static getGameObjectById(e){for(let t of r.layers){let n=t.getObjects().find(i=>i.uuid===e);if(n)return n}}static addBasicComponents(){this.components.set("Camera",I),this.components.set("Shape",B)}static init(e){this.initRootDiv(),this._renderer=e,E.init(),this.loadPlayConfig(le),this.addBasicComponents(),this.rootDiv.addEventListener("contextmenu",t=>t.preventDefault());for(let t of["mousedown","mouseup","mousemove","touchstart","touchmove","touchend"])document.addEventListener(t,this.sendEventToLayers.bind(this))}static pushLayer(e){e.canvas=this.createCanvas(),e.renderer=this._renderer,this.eventEmitter.addEventListener(e.onEvent.bind(e)),this.layers.push(e),e.onAttach()}static removeLayer(e){let t=r.layers.indexOf(e);t!==-1&&r.layers.splice(t,1)}static run(){requestAnimationFrame(r.mainTick.bind(r)),r.lastFrame=performance.now(),r._runningState=1}static runRenderingOnly(){requestAnimationFrame(r.renderOnlyTick.bind(r)),r.lastFrame=performance.now(),r._runningState=2}static stop(){r._runningState=0}static mainTick(e){this._deltaTime=(e-this.lastFrame)/1e3,this.lastFrame=e;for(let t of this.layers)t.onUpdate();for(let t of this.layers)t.onRender();r._runningState===1&&requestAnimationFrame(r.mainTick.bind(r))}static renderOnlyTick(e){this._deltaTime=(e-this.lastFrame)/1e3,this.lastFrame=e;for(let t of this.layers)t.onRender();r._runningState===2&&requestAnimationFrame(r.renderOnlyTick.bind(r))}static createCanvas(){let e=document.createElement("canvas"),t=this.getContextName(this.renderingContext.name),n=e.getContext(t);if(!n)throw new Error(`Rendering context ${t} was not found!`);return this.addResizing(e),n instanceof CanvasRenderingContext2D&&n.scale(r.dpr,r.dpr),this.rootDiv.appendChild(e),{element:e,ctx:n}}static getContextName(e){switch(e){case CanvasRenderingContext2D.name:return"2d";case WebGLRenderingContext.name:return"webgl";case WebGL2RenderingContext.name:return"webgl2";default:throw new Error(`Unsupported context type: "${e}"`)}}static addResizing(e){new ResizeObserver(()=>{setTimeout(()=>{e.width=+this.rootDiv.clientWidth,e.height=+this.rootDiv.clientHeight},0)}).observe(this.rootDiv)}static initRootDiv(e="root"){let t=document.getElementById(e);if(!t||!(t instanceof HTMLDivElement))throw new Error(`Html element with type "div" and id "${e}" was not found!`);this.rootDiv=t}static sendEventToLayers(e){this.eventEmitter.dispatchEvent(new k(e.type))}static loadPlayConfig(e){E.inputAxes=e.input.map(t=>new N(t.name,t.bindings))}};var D=class extends H{static{c(this,"Transform")}position;size;angle;constructor(e,t,n){super(),this.position=e??new b,this.size=t??new b(1,1),this.angle=n??0}};M([P("angle")],D.prototype,"angle",2);var w=class{static{c(this,"GameObject")}layer;components=[];transform;uuid;constructor(e,t,n){this.transform=t??new D,this.transform.parent=this,this.uuid=n??crypto.randomUUID(),e&&this.addComponents(e)}getAllComponents(){return this.components}onAttach(){for(let e of this.components)e.onAttach()}onUpdate(){this.updateComponents()}onRender(e){this.renderComponents(e)}updateComponents(){for(let e of this.components)e.onUpdate()}renderComponents(e){for(let t of this.components)t.onRender(e)}addComponent(e){return e.parent=this,this.components.push(e),this.layer&&e.onAttach(),e}addComponents(e){for(let t of e)this.components.push(t),t.parent=this;if(this.layer)for(let t of e)t.onAttach();return e}getComponent(e){return this.components.find(t=>t instanceof e)}getComponents(e){return this.components.filter(t=>t instanceof e)}hasComponent(e){return this.components.some(t=>t instanceof e)}removeComponent(e){let t=this.components.findIndex(n=>n instanceof e);return t===-1?!1:(this.components.splice(t,1),!0)}requireComponent(e){let t=this.getComponent(e);if(!t)throw new Error(`Required component ${e.name??"Unknown"} was not found.`);return t}};var L=class{static{c(this,"Layer")}canvas;renderer;objects=[];eventEmitter=new W(!0,!0);cameras=[];onAttach(){}onUpdate(){this.updateObjects()}onRender(){this.renderObjects()}updateObjects(){for(let e of this.objects)e.onUpdate()}renderObjects(){if(this.cameras.length!==0){this.renderer.setCanvas(this.canvas.element,this.canvas.ctx),this.renderer.clearCanvas();for(let e of this.cameras)if(e.enabled){this.renderer.fillColor=e.backgroundColor,this.renderer.fillCanvas(),this.renderer.resetTransform();let t=new b(this.canvas.ctx.canvas.width,this.canvas.ctx.canvas.height).divide(2);this.renderer.translate(t),this.renderer.rotate(e.angle),this.renderer.translate(b.zero.subtract(e.position));for(let n of this.objects)n.onRender(this.renderer)}}}addObject(e){return this.objects.push(e),e.layer=this,e.onAttach(),e}addObjects(e){for(let t of e)this.objects.push(t),t.layer=this,t.onAttach();return e}removeObject(e){let t=this.objects.indexOf(e);t!==-1&&this.objects.splice(t,1)}getObjects(){return this.objects}onEvent(e){this.eventEmitter.dispatchEvent(new k(e.type))}};var z=class{static{c(this,"ModuleLoader")}constructor(){}static createTempURL(e,t="text/javascript"){let n=new Blob([e],{type:t});return URL.createObjectURL(n)}static deleteTempUrl(e){URL.revokeObjectURL(e)}static async load(e){let t=this.createTempURL(e),n=await import(t);if(this.deleteTempUrl(t),n.System)for(let i of Object.keys(p))n.System[i]=p[i];if(n.Input)for(let i of Object.keys(E))n.Input[i]=E[i];if(n.Metadata){f.importFrom(n.Metadata);for(let i of Object.keys(f))n.Metadata[i]=f[i]}return n}};var A=class r{static{c(this,"Builder")}static tab;static compiled;constructor(){}static async compile(e=!0,t){let n=await h.getAllTextFiles(h.folderHandle),i=n.files,o=n.assets;for(let{fileHandle:s,path:a}of i){let d=await(await s.getFile()).text();x.files.set(a,d)}try{let s=(await x.bundle(t)).outputFiles[0]?.text;if(!s)return!1;this.compiled=s,u.assetsWindow.clearAssets();for(let a of o)u.assetsWindow.addAsset(a);return!0}catch(s){return e&&v.notify(`${s}`,"danger",15e3),!1}}static async build(){if(!h.folderHandle)return v.notify("Open project first.","danger"),!1;let e=await h.folderHandle.getDirectoryHandle("build",{create:!0}),n=await(await h.folderHandle.getFileHandle("project.gz")).getFile(),i=new DecompressionStream("gzip"),o=await new Response(n.stream().pipeThrough(i)).arrayBuffer(),s=new TextDecoder().decode(o);if(x.files.clear(),x.files.set("index.ts",y.userIndex),x.files.set("main.ts",`import * as index from "./index";
import { Renderer2D } from "@flint/shared/renderer2d";
import { System } from "@flint/runtime/system";
import { ProjectLoader } from "@flint/runtime/project-loader";

System.init(new Renderer2D());

for (const [name, _] of Object.entries(index)) {
    const value = index[name];
    System.components.set(name, value as any);
}
const projectData = ProjectLoader.deserialize(\`${s}\`);

for (const layer of projectData.layers) System.pushLayer(layer);

System.run();
`),await r.compile(!0,"/main.ts")){let a=`<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Build</title></head>
<style>
body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}
canvas {
    position: absolute;
}
#root {
    width: 100%;
    height: 100%;
}
</style>
<body>
<div id="root"></div>
<script>
${r.compiled}
<\/script>
</body>
</html>`,l=await e.getFileHandle("index.html",{create:!0}),d=await l.createWritable();await d.write(a),await d.close();let m=await l.getFile(),T=URL.createObjectURL(m);r.tab&&r.tab.close(),r.tab=window.open(T,"build")}else return!1;return!0}static async buildForEditor(e=!0){if(!h.folderHandle)return v.notify("Open project first.","danger"),!1;if(x.files.clear(),x.files.set("index.ts",y.fullIndex),await r.compile(e)){let t=await z.load(r.compiled);for(let n of y.config.components.map(i=>i.name)){let i=t[n],o=p.components.get(n);if(i&&p.components.set(n,i),!o||!o.prototype)return!0;let s=p.components.get(n);if(!s)return!1;for(let a of p.layers)for(let l of a.getObjects()){let d=l.getComponent(o);d&&(l.addComponent(d.swapClass(s)),l.removeComponent(o))}}}else return!1;return!0}};function oe(r,e){if(!(!r||!e))for(let t of Object.keys(r)){let n=r[t],i=e[t];if(!(i==null||typeof i!="object")&&!(n==null||typeof n!="object")){if(Array.isArray(n)&&Array.isArray(i)){for(let o=0;o<n.length;o++){let s=n[o],a=i[0];s&&typeof s=="object"&&a&&typeof a=="object"&&(Object.setPrototypeOf(s,Object.getPrototypeOf(a)),oe(s,a))}continue}Object.setPrototypeOf(n,Object.getPrototypeOf(i)),oe(n,i)}}}c(oe,"restorePrototypesDeep");var G=class{static{c(this,"ProjectLoader")}constructor(){}static deserialize(e){let t=JSON.parse(e),n={layers:[]};for(let i of t.layers){let o=new L;for(let s of i.objects){let a=null,l=[];for(let m of s.components){let T=p.components.get(m.name)||(m.name==="Transform"?D:void 0);if(!T){console.warn(`Component "${m.name}" not registered.`);continue}let R=new T,O=m.data;oe(O,R);let g=new T;Object.assign(g,O),g instanceof D?a=g:l.push(g)}let d=new w(l,a,s.uuid);o.addObject(d)}n.layers.push(o)}return n}static serialize(e){let t={layers:[]};for(let n of e.layers){let i={objects:[]};for(let o of n.getObjects()){let s={uuid:o.uuid,components:[]};for(let a of[o.transform,...o.getAllComponents()]){let l={name:a.constructor.name,data:{}};for(let d of Object.keys(a))d!=="parent"&&(l.data[d]=a[d]);s.components.push(l)}i.objects.push(s)}t.layers.push(i)}return JSON.stringify(t)}static load(e){for(let t of e.layers)p.pushLayer(t)}};var se=class r{static{c(this,"FileTracker")}constructor(){}static timestamps=new Map;static intervalId=null;static debounceTimer=null;static debounceDelay=200;static async startWatchingDirectory(e){this.intervalId===null&&(this.intervalId=setInterval(async()=>{await this.directoryWasUpdated(e)&&this.scheduleRebuild()},this.debounceDelay))}static stopWatching(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null),this.debounceTimer!==null&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}static scheduleRebuild(){this.debounceTimer!==null&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(async()=>{let e=performance.now();await A.buildForEditor(!1);let t=performance.now();r.debounceDelay=t-e,this.stopWatching(),this.startWatchingDirectory(h.folderHandle),this.debounceTimer=null},this.debounceDelay)}static async directoryWasUpdated(e,t=""){let n=!1;for await(let i of e.values()){let o=t?`${t}/${i.name}`:i.name;if(i.kind==="file"){if(o.endsWith("metadata.json"))continue;await this.wasUpdated(o,i)&&(n=!0)}i.kind==="directory"&&await this.directoryWasUpdated(i,o)&&(n=!0)}return n}static async wasUpdated(e,t){let i=(await t.getFile()).lastModified,o=this.timestamps.get(e);return this.timestamps.set(e,i),o!==void 0&&o!==i}},h=class r{static{c(this,"Project")}static folderHandle;static createComponentDialog;static createComponentButton;static createComponentInput;static names=new Map;constructor(){}static{r.createComponentDialog=document.getElementById("create-component-dialog"),r.createComponentButton=r.createComponentDialog.querySelector("sl-button"),r.createComponentButton.addEventListener("click",()=>{r.createComponentDialog.hide(),r.createComponent(r.createComponentInput.value.trim())}),r.createComponentInput=r.createComponentDialog.querySelector("sl-input"),r.createComponentInput.addEventListener("sl-input",()=>{r.createComponentButton.disabled=r.createComponentInput.value.trim()===""})}static async run(){return await r.saveProject(),await A.buildForEditor()}static async stop(){let e=await r.loadProject();return u.hierarchyWindow.onUpdate(),u.inspectorWindow.currentObject&&(u.inspectorWindow.currentObject=p.getGameObjectById(u.inspectorWindow.currentObject.uuid)),e}static async openProject(e){await r.startupProject(e),await r.loadProject(),u.hierarchyWindow.onUpdate(),setInterval(async()=>{await r.saveProject()},6e4)}static async newProject(e){(await r.startupProject(e)||!await r.loadProject())&&(p.pushLayer(u.defaultLayer),u.hierarchyWindow.onUpdate()),await r.saveProject(),u.hierarchyWindow.onUpdate(),setInterval(async()=>{await r.saveProject()},6e4)}static async buildAndRun(){return await A.build()}static async saveProject(){let e=G.serialize({layers:p.layers}),t=new Blob([e],{type:"text/plain"}),n=new CompressionStream("gzip"),i=new Response(t.stream().pipeThrough(n)),s=await(await r.folderHandle.getFileHandle("project.gz",{create:!0})).createWritable();await s.write(await i.arrayBuffer()),await s.close()}static async loadProject(){try{let t=await(await r.folderHandle.getFileHandle("project.gz")).getFile(),n=new DecompressionStream("gzip"),i=await new Response(t.stream().pipeThrough(n)).arrayBuffer(),o=new TextDecoder().decode(i),s=G.deserialize(o);p.layers.length=0;for(let a of s.layers)p.pushLayer(a);return!0}catch(e){return console.log("could not load the project:",e),!1}}static async startupProject(e){r.folderHandle=e;let t=await y.ensureLoaded();return await r.getAllTextFiles(r.folderHandle),t&&(u.loadingDialogProgressBar.value=0,u.loadingDialogProgressBar.indeterminate=!1,u.loadingDialog.show(),await r.copyTypesToDirectory(e,window.location.href.replace(/index\.html$/,"")+"/types/",(n,i)=>{u.loadingDialogProgressBar.value=i/n*100})),await f.loadFromFile(r.folderHandle),await f.saveToFile(r.folderHandle),await A.buildForEditor(),u.loadingDialog.hide(),await se.startWatchingDirectory(r.folderHandle),t}static async getAllTextFiles(e,t=""){let n=[],i=[];for await(let[o,s]of e.entries())if(s.kind==="file"&&(o.endsWith(".ts")||o.endsWith(".json")))i.push({id:crypto.randomUUID(),name:o,type:o.split(".").pop()==="ts"?"component":"json",path:"/"+t+o}),n.push({fileHandle:s,path:t+o});else if(s.kind==="directory"){i.push({id:crypto.randomUUID(),name:o,type:"folder",path:"/"+t+o});let a=(await r.getAllTextFiles(s,t+o+"/")).files;n.push(...a)}return{files:n,assets:i}}static async openInFileEditor(e){if(!y.config.rootPath){let t=prompt("Due to browser restrictions - to open file in VSCode enter absolute path to your project folder:","C:/path/to/your/project/folder");if(!t)return;y.config.rootPath=t,await y.save()}window.location.href="vscode://file/"+y.config.rootPath+e}static showCreateComponentWindow(){r.createComponentButton.disabled=!0,r.createComponentInput.value="",r.createComponentDialog.show()}static async createComponent(e){e=j.joinToPascalCase(e);let t=j.splitPascalCase(e,"-"),n=u.assetsWindow.currentPath.replace(/^\//,""),i=`${n}/${t}.ts`,o=`import Component from "@flint/runtime/component";

export class ${e} extends Component {
    onAttach() {
        // Component initialization code
    }

    onUpdate() {
        // Code which should run every frame
    }
}
`,s=r.folderHandle,a=n.split("/").filter(Boolean);for(let m of a)s=await s.getDirectoryHandle(m,{create:!0});let d=await(await s.getFileHandle(t+".ts",{create:!0})).createWritable();await d.write(o),await d.close(),u.assetsWindow.addAsset({id:crypto.randomUUID(),name:t+".ts",type:"component",path:i,data:e}),y.config.components.push({name:e,file:i}),await y.save(),await r.openInFileEditor("/"+i)}static async deleteComponent(e){let t=j.splitPascalCase(e,"-"),n=u.assetsWindow.currentPath.replace(/^\//,""),i=`${n}/${t}.ts`,o=r.folderHandle,s=n.split("/").filter(Boolean);for(let a of s)if(o=await o.getDirectoryHandle(a,{create:!1}),!o)return;try{await o.removeEntry(t+".ts")}catch(a){console.warn("File not found:",a)}y.config.components.splice(y.config.components.findIndex(a=>a.name===e),1),await y.save(),u.assetsWindow.removeAsset(i)}static async copyTypesToDirectory(e,t,n){let i=await fetch(t+"files.json").then(l=>l.json()),o=[...i.types||[],...i.json||[]],s=[],a=0;for(let l of o)s.push((async()=>{let d=t+l,m;l.endsWith("d.ts")?m=await fetch(d):m=await fetch(t.replace("types/","src/")+l);let T=await m.text(),R=l.split("/"),O=R.pop(),g=e;for(let re of R)g=await g.getDirectoryHandle(re,{create:!0});let V=await(await g.getFileHandle(O,{create:!0})).createWritable();await V.write(T),await V.close(),n&&n(o.length,++a)})());await Promise.all(s),console.log("All type/json files copied!")}};var y=class r{static{c(this,"ProjectConfig")}static configFileName="project-config.json";static config;static index='export * from "@flint/runtime/system";export { default as Input } from "@flint/shared/input";export { default as Metadata } from "@flint/shared/metadata";';static get fullIndex(){return r.index+r.config.components.map(e=>`export * from "./${e.file}";`).join("")}static get userIndex(){return r.config.components.map(e=>`export * from "./${e.file}";`).join("")}static tsConfig=`{
    "compilerOptions": {
        "baseUrl": ".",
        "paths": {
            "@flint/*": [
                "flint/*"
            ]
        },
        "experimentalDecorators": true,
        "emitDecoratorMetadata": true,
    }
}`;static defaultConfig={components:[]};static async save(){let t=await(await h.folderHandle.getFileHandle(r.configFileName,{create:!0})).createWritable();await t.write(JSON.stringify(r.config,null,4)),await t.close()}static async load(){try{let n=await(await(await h.folderHandle.getFileHandle(r.configFileName)).getFile()).text();this.config=JSON.parse(n);let o=await(await h.folderHandle.getFileHandle("tsconfig.json")).getFile();return r.tsConfig=await o.text(),!0}catch{return!1}}static async create(){let t=await(await h.folderHandle.getFileHandle(r.configFileName,{create:!0})).createWritable();await t.write(JSON.stringify(r.defaultConfig,null,4)),await t.close();let i=await(await h.folderHandle.getFileHandle("tsconfig.json",{create:!0})).createWritable();await i.write(r.tsConfig),await i.close()}static async ensureLoaded(){return await r.load()?!1:(await r.create(),r.config=r.defaultConfig,!0)}};var x=class r{static{c(this,"Bundler")}static files=new Map;static flintFiles=new Map;static esbuild;static virtualFsPlugin={name:"virtual-fs",setup(e){e.onResolve({filter:/.*/},t=>{let n=t.path.endsWith(".ts")||t.path.endsWith(".json")?t.path:t.path+".ts";if(n.startsWith("@flint"))return{path:n,namespace:"virtual"};let i=t.importer?t.importer.replace(/\/[^/]*$/,""):t.resolveDir;i=i.replace(/\\/g,"/");let o=i.split("/").filter(Boolean),s=n.split("/").filter(Boolean),a=[];if(!i.includes(".")&&(n.startsWith("./")||n.startsWith("../"))){a.push(...o);for(let d of s)d!=="."&&(d===".."?a.pop():a.push(d))}else a.push(...s);let l=a.join("/");return{path:l.startsWith(".")?l.slice(2,l.length):l,namespace:"virtual"}}),e.onLoad({filter:/.*/,namespace:"virtual"},t=>{if(t.path.startsWith("@flint")){let o="flint/"+t.path.replace("@flint/",""),s=r.flintFiles.get(o);return s?{contents:s,loader:o.endsWith(".ts")?"ts":"json"}:(console.warn("Missing virtual flint file:",o),{contents:"export {}",loader:o.endsWith(".json")?"json":"ts"})}let n=t.path,i=r.files.get(n);if(!i){let o=r.flintFiles.get(n);return o?{contents:o,loader:n.endsWith(".ts")?"ts":"json"}:(console.warn("Missing virtual file:",n),{contents:"export {}",loader:"ts"})}return{contents:i,loader:n.endsWith(".ts")?"ts":"json"}})}};constructor(){}static async init(){if(!r.esbuild){let{default:e}=await import("https://esm.sh/esbuild-wasm@0.19.12");await e.initialize({wasmURL:"https://esm.sh/esbuild-wasm@0.19.12/esbuild.wasm"}),r.esbuild=e}return r}static async bundle(e="/index.ts"){return await r.esbuild.build({entryPoints:[e],bundle:!0,write:!1,format:"esm",target:["esnext"],plugins:[r.virtualFsPlugin],external:["@flint/"],minify:!0,keepNames:!0,tsconfigRaw:y.tsConfig})}};var K=class{static{c(this,"Assets")}element;gridElement;contextDropdownElement;contextMenuElement;cachedWidth=0;cachedHeight=0;allAssets=[];currentPath="/";backButton;constructor(e,t){this.element=e,this.gridElement=t,this.contextDropdownElement=this.element.querySelector("#assets-context-dropdown"),this.contextMenuElement=this.contextDropdownElement.querySelector("#assets-context-menu"),this.backButton=document.getElementById("assets-back-button"),this.setupButtons(),this.setupContextMenu(),this.renderCurrentFolder()}setupButtons(){[{id:"new-folder-button",type:"folder",label:"New Folder"},{id:"new-json-button",type:"json",label:"New JSON"}].forEach(({id:t,type:n,label:i})=>{document.getElementById(t).addEventListener("click",()=>{let s=this.allAssets.filter(l=>l.path.startsWith(this.currentPath+"/")&&l.type===n).length+1,a={id:crypto.randomUUID(),name:`${i} ${s}`,type:n,path:`${this.currentPath}${this.currentPath==="/"?"":"/"}${i} ${s}`,data:""};this.addAsset(a)})}),document.getElementById("new-component-button").addEventListener("click",()=>{h.showCreateComponentWindow()}),this.backButton.addEventListener("click",()=>{this.goBack(),this.updateBackButton()}),this.updateBackButton()}updateBackButton(){this.backButton.disabled=this.currentPath==="/"}goBack(){if(this.currentPath==="/")return;let e=this.currentPath.split("/").filter(Boolean);e.pop(),this.currentPath="/"+e.join("/"),this.currentPath===""&&(this.currentPath="/"),this.renderCurrentFolder()}setupContextMenu(){this.contextDropdownElement.addEventListener("sl-after-show",()=>{this.cachedWidth===0&&(this.cachedWidth=this.contextMenuElement.clientWidth,this.cachedHeight=this.contextMenuElement.clientHeight)}),this.element.addEventListener("contextmenu",e=>{e.preventDefault(),this.contextDropdownElement.show(),this.cachedWidth===0?(this.positionDropdown(e),this.contextDropdownElement.addEventListener("sl-after-show",()=>this.positionDropdown(e),{once:!0})):this.positionDropdown(e)})}positionDropdown(e){let t=Math.min(document.body.clientWidth-this.cachedWidth,e.pageX),n=Math.min(document.body.clientHeight-this.cachedHeight,e.pageY);Object.assign(this.contextDropdownElement.style,{left:`${t}px`,top:`${n}px`}),this.contextDropdownElement.reposition()}addAsset(e){this.allAssets.push(e),this.renderCurrentFolder()}removeAsset(e){this.allAssets=this.allAssets.filter(t=>!t.path.startsWith(e)),this.renderCurrentFolder()}clearAssets(){this.allAssets=[],this.renderCurrentFolder()}renderCurrentFolder(){this.gridElement.innerHTML="";let e=this.currentPath==="/"?"/":this.currentPath+"/";this.allAssets.filter(n=>{let i=n.path.replace(e,"");return n.path.startsWith(e)&&!i.includes("/")}).sort((n,i)=>{let o=c(d=>d.type==="folder"?0:d.path.endsWith(".json")?2:1,"typeOrder"),s=o(n)-o(i);if(s!==0)return s;let a=n.name.toLowerCase(),l=i.name.toLowerCase();return a<l?-1:a>l?1:0}).forEach(n=>this.renderAsset(n)),this.updateBackButton()}getIconForType(e){return e==="folder"?"folder2":e==="component"?"code-slash":e==="json"?"text-left":"file"}renderAsset(e){let t=document.createElement("div");t.className="asset-card",t.draggable=!0,t.dataset.path=e.path,t.innerHTML=`
            <sl-card class="asset-card-inner">
                <sl-icon name="${this.getIconForType(e.type)}" class="asset-icon"></sl-icon>
                <span class="asset-name">${e.name}</span>
            </sl-card>
        `;let n=t.querySelector(".asset-name");if(e.type!=="folder"){let o=function(s){s.dataTransfer.items.add(e.data,"text/plain")};var i=o;if(c(o,"dragstartHandler"),e.type==="component"&&e.data===void 0){let s=y.config.components.find(a=>a.file===e.path)?.name;s&&(e.data=s)}t.addEventListener("dragstart",o)}t.addEventListener("dblclick",async()=>{e.type==="folder"?this.enterFolder(e.path):await this.onAssetOpen(e)}),this.setupAssetNameEdit(n,e),this.gridElement.appendChild(t)}setupAssetNameEdit(e,t){}enterFolder(e){this.currentPath=e,this.renderCurrentFolder()}async onAssetOpen(e){e.type!=="folder"&&await h.openInFileEditor(e.path)}};function X(r){return e=>{typeof e=="function"?f.setClass(e.prototype,"editor-name",r):f.setClass(e,"editor-name",r)}}c(X,"editorName");var q=class{static{c(this,"Hierarchy")}element;layers=new Map;selection;selectedElement;contextDropdownElement;contextMenuElement;cachedWidth=0;cachedHeight=0;deleteButton;constructor(e){this.element=e,this.element.addEventListener("sl-selection-change",this.onSelectionChange.bind(this)),this.contextDropdownElement=this.element.parentElement.querySelector("#hierarchy-context-dropdown"),this.contextMenuElement=this.contextDropdownElement.querySelector("#hierarchy-context-menu"),this.deleteButton=this.contextMenuElement.querySelector("#delete-button"),this.setupContextMenu()}setupContextMenu(){this.contextDropdownElement.addEventListener("sl-after-show",()=>{this.cachedWidth===0&&(this.cachedWidth=this.contextMenuElement.clientWidth,this.cachedHeight=this.contextMenuElement.clientHeight)}),this.element.parentElement.addEventListener("contextmenu",e=>{e.preventDefault(),this.contextDropdownElement.show(),e.target===this.element.parentElement||e.target===this.element||e.target!==this.selectedElement?this.deleteButton.style.display="none":this.deleteButton.style.display="block",this.cachedWidth===0?(this.positionDropdown(e),this.contextDropdownElement.addEventListener("sl-after-show",()=>this.positionDropdown(e),{once:!0})):this.positionDropdown(e)}),this.contextMenuElement.querySelector("#new-layer-button").addEventListener("click",()=>{let e=new L;p.pushLayer(e),this.onUpdate()}),this.contextMenuElement.querySelector("#new-gameobject-button").addEventListener("click",()=>{this.createObject()}),this.contextMenuElement.querySelector("#delete-button").addEventListener("click",()=>{this.deleteSelected()})}positionDropdown(e){let t=Math.min(document.body.clientWidth-this.cachedWidth,e.pageX),n=Math.min(document.body.clientHeight-this.cachedHeight,e.pageY);Object.assign(this.contextDropdownElement.style,{left:`${t}px`,top:`${n}px`}),this.contextDropdownElement.reposition()}onSelectionChange(e){let t=e.detail.selection;this.selectedElement=t[0];let n=t[0].hierarchyId.split("-").map(o=>Number.parseInt(o)),i=this.layers.get(n[0]??0);if(n[1]?this.selection=i?.getObjects()[n[1]]:this.selection=i,!this.selection)throw new Error("Failed to get 'selection'")}createObject(){if(this.selection)this.selection instanceof L?this.selection.addObject(new w):this.selection.layer.addObject(new w);else{if(p.layers.length===0){v.notify("GameObject can be created only inside a Layer.","danger");return}p.layers[0].addObject(new w)}this.onUpdate()}deleteSelected(){this.selection&&(this.selection instanceof w?this.selection.layer.removeObject(this.selection):p.removeLayer(this.selection),u.hierarchyWindow.onUpdate())}async onUpdate(){this.layers.clear(),this.element.innerHTML="";for(let t=p.layers.length-1;t>=0;t--){let n=p.layers[t],i=f.getClass(n,"editor-name")??`new Layer${t>0?" "+t:""}`,o=this.addItem(i,t.toString(),this.element),s=n.getObjects();for(let a=s.length-1;a>=0;a--){let l=f.getClass(s[a],"editor-name")??`new GameObject${a>0?" "+a:""}`;this.addItem(l,`${t}-${a}`,o)}this.layers.set(t,n)}document.querySelectorAll("sl-tree-item").forEach(t=>{t.addEventListener("dblclick",async()=>{if(t.querySelector("sl-input"))return;let n=Array.from(t.childNodes).find(a=>a.nodeType===Node.TEXT_NODE);n||(n=document.createTextNode(""),t.prepend(n));let i=n.textContent||"",o=document.createElement("sl-input");o.type="text",o.value=i,o.style.width="100%",n.textContent="",t.appendChild(o),await customElements.whenDefined("sl-input"),o.focus(),o.select();let s=c(a=>{n.textContent=a&&o.value||i;let l=t.hierarchyId;if(l){l=l.split("-").map(T=>Number.parseInt(T));let m=u.hierarchyWindow.layers.get(l[0]??0)?.getObjects()[l[1]??0];f.setClass(m,"inspector-name",n.textContent)}o.remove()},"exitEdit");o.addEventListener("sl-blur",()=>s(!0)),o.addEventListener("keydown",a=>{a.key==="Enter"&&s(!0),a.key==="Escape"&&s(!1)})})})}addItem(e,t,n){let i=Object.assign(document.createElement("sl-tree-item"),{textContent:e,hierarchyId:t,expanded:!0});return n.appendChild(i),i}};var ae=class{static{c(this,"InspectorComponent")}element;component;constructor(e){this.component=e,this.element=Object.assign(document.createElement("sl-details"),{summary:e.constructor.name,open:!0}),this.generateContent()}generateContent(){this.element.appendChild(j.build(this.component))}},J=class{static{c(this,"Inspector")}minSize=new b(250,100);currentObject;components=[];dropTarget=null;element;dialog;dialogSelect;addComponentButton;dialogAddButton;constructor(e,t){this.element=e,this.dialog=t,this.dropTarget=document.getElementById("inspector-drop-target"),this.dropTarget.addEventListener("dragover",n=>{n.preventDefault()}),this.dropTarget.addEventListener("drop",n=>{n.preventDefault(),n.dataTransfer.items[0]?.getAsString(i=>{this.currentObject?.addComponent(new(p.components.get(i)))})}),this.dialogSelect=this.dialog.getElementsByTagName("sl-select")[0],this.dialogAddButton=this.dialog.getElementsByTagName("sl-button")[0],u.hierarchyWindow.element.addEventListener("sl-selection-change",this.onEvent.bind(this)),this.addComponentButton=document.getElementById("add-component-button"),this.addComponentButton.addEventListener("click",this.addComponent.bind(this)),this.dialogSelect.addEventListener("sl-change",()=>{this.dialogAddButton.disabled=!1}),this.dialogAddButton.addEventListener("click",()=>{if(this.dialog.hide(),this.currentObject){let n=p.components.get(this.dialogSelect.value);if(!n)return;this.currentObject.addComponent(new n)}})}async addComponent(){if(!this.currentObject){v.notify("Select object first.","primary");return}this.dialogAddButton.disabled=!0,this.dialogSelect.innerHTML="";for(let[e,t]of p.components)t.name!==void 0&&this.dialogSelect.appendChild(Object.assign(document.createElement("sl-option"),{value:t.name,textContent:j.splitPascalCase(t.name)}));this.dialogSelect.value="",this.dialog.show()}addInspectorComponent(e){let t=new ae(e);this.element.appendChild(t.element),this.components.push(t)}onEvent(e){let n=e.detail.selection[0].hierarchyId.split("-").map(o=>Number.parseInt(o));if(n.length!==2)return;let i=u.hierarchyWindow.layers.get(n[0]??0);if(this.currentObject=i?.getObjects()[n[1]??0],!this.currentObject)throw new Error("Failed to get 'currentObject'");this.element.innerHTML="",this.addComponentButton.style.display="initial",j.clearFields(),this.components=[],this.addInspectorComponent(this.currentObject.transform);for(let o of this.currentObject.getAllComponents())this.addInspectorComponent(o)}componentsMatch(){if(!this.currentObject)return!1;let e=[this.currentObject.transform,...this.currentObject.getAllComponents()];if(e.length!==this.components.length)return!1;for(let t=0;t<e.length;t++)if(this.components[t].component!==e[t])return!1;return!0}update(){if(this.currentObject){if(!this.componentsMatch()){this.element.innerHTML="",j.clearFields(),this.components=[],this.addInspectorComponent(this.currentObject.transform);for(let e of this.currentObject.getAllComponents())this.addInspectorComponent(e)}j.updateFields()}}};var v=class{static{c(this,"Notifier")}static escapeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}static async notify(e,t,n=4e3){let i={primary:"info-circle",success:"check2-circle",neutral:"gear",warning:"exclamation-triangle",danger:"exclamation-octagon"},o=Object.assign(document.createElement("sl-alert"),{countdown:"ltr",variant:t,closable:!0,duration:n,innerHTML:`
        <sl-icon name="${i[t]}" slot="icon"></sl-icon>
        ${this.escapeHtml(e)}
      `});document.body.append(o),await customElements.whenDefined("sl-alert"),o.toast()}},S=class{static{c(this,"ToolBarActions")}constructor(){}static async newProject(){await h.newProject(await window.showDirectoryPicker({mode:"readwrite",id:"project"})),u.onProjectLoad(),v.notify("Project created successfully.","success")}static async openProject(){await h.openProject(await window.showDirectoryPicker({mode:"readwrite",id:"project"})),u.onProjectLoad(),v.notify("Project loaded successfully.","success")}static async saveProject(){try{await h.saveProject(),v.notify("Project saved successfully.","success")}catch(e){v.notify("Could not save the project: "+e,"warning")}}static async buildAndRun(){await h.saveProject(),await h.buildAndRun()&&v.notify("Project builded successfully.","success")}static async runProject(){let e=u.runButtonIcon.name==="play";u.runButtonIcon.name=e?"stop":"play",e?await h.run()&&(p.run(),v.notify("Project started.","primary")):await h.stop()&&(p.runRenderingOnly(),v.notify("Project stopped.","primary"))}},u=class r{static{c(this,"Editor")}static draggedItem;static hierarchyWindow;static inspectorWindow;static assetsWindow;static runButton;static runButtonIcon;static loadingDialog;static loadingDialogProgressBar;static _defaultLayer;static get defaultLayer(){return this._defaultLayer}static _running=!1;static get running(){return this._running}constructor(){}static init(){x.init();try{let n=document.getElementById("add-component-dialog");r.hierarchyWindow=new q(document.getElementById("hierarchy-tree")),r.inspectorWindow=new J(document.getElementById("inspector-body"),n),r.assetsWindow=new K(document.getElementById("assets-window"),document.getElementById("assets-grid")),r.loadingDialog=document.getElementById("loading-dialog"),r.loadingDialog.addEventListener("sl-request-close",function(i){i.detail.source==="overlay"&&i.preventDefault()}),r.loadingDialogProgressBar=r.loadingDialog.querySelector("sl-progress-bar"),document.getElementById("new-project-button").addEventListener("click",S.newProject),document.getElementById("open-project-button").addEventListener("click",S.openProject),document.getElementById("save-project-button").addEventListener("click",S.saveProject),document.addEventListener("keydown",async function(i){i.ctrlKey&&i.code==="KeyS"&&(i.preventDefault(),i.stopImmediatePropagation(),await S.saveProject())},!0),document.getElementById("build-and-run-button").addEventListener("click",S.buildAndRun),document.addEventListener("keydown",async function(i){i.ctrlKey&&i.code==="KeyB"&&(i.preventDefault(),i.stopImmediatePropagation(),await S.buildAndRun())},!0),this.runButton=document.getElementById("run-button"),this.runButton.addEventListener("click",S.runProject),this.runButtonIcon=this.runButton.querySelector("sl-icon"),document.getElementById("create-object-button").addEventListener("click",r.hierarchyWindow.createObject.bind(r.hierarchyWindow))}catch(n){console.error(`Error: Failed to initialize UI: ${n}`)}r.hierarchyWindow.onUpdate(),r.updateInspectorFields(),r.loadEngineFiles(),r._defaultLayer=new L;let e=new w([new B],new D(void 0,new b(100,100)));X("Rect")(e);let t=new w([new I]);X("Camera")(t),r._defaultLayer.addObjects([e,t]),X("New Layer")(L),X("New GameObject")(w)}static async loadEngineFiles(){let e=await fetch(window.location.href.replace(/index\.html$/,"")+"/types/files.json").then(o=>o.json()),t=window.location.href.replace(/index\.html$/,"")+"/src/",n=[...e.types||[],...e.json||[]],i=[];for(let o of n)i.push((async()=>{let s=o.replace("d.ts","ts"),a=t+s,l=await fetch(a).then(d=>d.text());x.flintFiles.set(s,l)})());await Promise.all(i),console.log("All flint files loaded")}static updateInspectorFields(){r.inspectorWindow.update(),requestAnimationFrame(r.updateInspectorFields)}static onProjectLoad(){r.runButton.disabled=!1}};p.init(new Z);p.runRenderingOnly();u.init();})();
